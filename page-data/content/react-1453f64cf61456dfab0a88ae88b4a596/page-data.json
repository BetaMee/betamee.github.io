{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/content/react-1453f64cf61456dfab0a88ae88b4a596","result":{"data":{"site":{"siteMetadata":{"author":"橡树上","title":"十二棵橡树"}},"markdownRemark":{"id":"2f0da29e-d72a-5fa0-a55a-4b7af9f96934","html":"<h2 id=\"目录\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%BD%95\" aria-label=\"目录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目录</h2>\n<!-- toc -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li>\n<p><a href=\"#Redux-%E7%9A%84%E8%AE%BE%E8%AE%A1\">Redux 的设计</a></p>\n<ul>\n<li><a href=\"#%E5%85%A8%E5%B1%80-store-%E7%9A%84%E8%AE%BE%E8%AE%A1\">全局 store 的设计</a></li>\n<li><a href=\"#getState-%E7%9A%84%E5%AE%9E%E7%8E%B0\">getState 的实现</a></li>\n<li><a href=\"#subscribe-%E7%9A%84%E5%AE%9E%E7%8E%B0\">subscribe 的实现</a></li>\n<li><a href=\"#dispatch-%E7%9A%84%E5%AE%9E%E7%8E%B0\">dispatch 的实现</a></li>\n<li><a href=\"#%E5%9F%BA%E6%9C%AC%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%80%BB%E7%BB%93\">基本运行模型总结</a></li>\n<li><a href=\"#Redux-%E4%B8%AD%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9C%AF%E8%AF%AD\">Redux 中的概念与术语</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#Redux-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86\">Redux 中间件的设计思路及其实现原理</a></p>\n<ul>\n<li><a href=\"#%E5%B8%B8%E8%A7%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%88%90%E5%9E%8B\">常规中间件的成型</a></li>\n<li><a href=\"#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%94%B9%E9%80%A0%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%92%8C-applyMiddleware-%E6%A8%A1%E5%9D%97\">函数式编程改造中间件和 applyMiddleware 模块</a></li>\n<li><a href=\"#%E6%B4%8B%E8%91%B1%E5%9C%88%E6%A8%A1%E5%9E%8B\">洋葱圈模型</a></li>\n<li><a href=\"#%E5%BC%82%E6%AD%A5%E4%B8%AD%E9%97%B4%E4%BB%B6\">异步中间件</a></li>\n<li><a href=\"#redux-thunk\">redux-thunk</a></li>\n<li><a href=\"#redux-soga\">redux-soga</a></li>\n</ul>\n</li>\n<li><a href=\"#Redux-%E7%9A%84%E8%BE%85%E5%8A%A9%E6%A8%A1%E5%9D%97-combineReducers-%E5%92%8C-bindActionCreators\">Redux 的辅助模块 combineReducers 和 bindActionCreators</a></li>\n<li><a href=\"#React-Redux-%E7%9A%84%E8%AE%BE%E8%AE%A1\">React-Redux 的设计</a></li>\n<li>\n<p><a href=\"#%E7%9B%B8%E5%85%B3%E5%BA%93%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%85%B6%E5%8E%9F%E7%90%86\">相关库使用及其原理</a></p>\n<ul>\n<li><a href=\"#reselectjs\">reselect.js</a></li>\n<li><a href=\"#redux-ignore\">redux-ignore</a></li>\n</ul>\n</li>\n<li><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n<!-- tocstop -->\n<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>Redux 是 React 社区非常有名的状态管理库。思考一下，在出现 Redux 这种状态管理库之前，React 组件之间要相互通信，只能依赖父子组件相互传递，即靠两个组件的共用父组件来传递信息，如果两个组件离得比较远，那么通信成本就会倍增，为了传递一个值，需要层层穿透不同的组件，非常冗余和复杂。</p>\n<p>而 Redux 的出现，即是为解决这个问题而生的。它将整个应用的状态提炼出来，放在一个单一的公共 store 中来管理。如果需要传递数据进行组件之间通信，只要改变这个公共 store，其他组件就能得到更新，无需数据的层层传递。</p>\n<p>下图是 Redux 的使用模型，详见<a href=\"https://betamee.github.io/content/react-afa32e6d440952fcab1dc6f77363d5ae\">React 状态管理使用指南</a>一文。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.60000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACsklEQVQ4y51Uy27TQBTt3yHY8AWoi7IFlkGABCwKQkJIlNIuUCWoEJsCUkXVBRSKigRtoyobqjZ1Xs7TTRzbSfwYjx+HmUns2k0TEKNcTWZ8595zzz0zM5gwwjAUc8BmgxL4QZDanzRmuEPkFP0Xa/ZzAx9bDQmrJwf4dloG8b2U34UBzyNKjpOeiuXcDlYOdvDqcBd5ozNEzdCmkieSpBC2Wi2oqopevw/qEMhGF0vZbWGLe18h97pT6YlL5vXxuV6vo1arQZZlHB8fw+wPUDJ1fGflSgytY9nwPA+GrqPf67FZgzkYpBEmM4ShD5c1wHFsaJoOSt0xJJZlQdUN9IkL3bRgunS8ZD4MzcL25hG2Ph2iUe1M7aTXUWCuPIP5ch5+RRoGHKkgDrj5IYeF+Q28eLyJjbUcDMMQFCgtRVBQrVbZuoZWuwNt+Qnka5dQmb0M9cFNhN5Z9+Muf3y7j+fz61h4tI61N7twbAJCCCud8WSasFmpjuPAZDyqT++iOHsF0txVdDJzCBhFccAIYbWk4v1qFmuv91CW2mfljbInB83/Rvf+Dai3r8P88WVEcDDeFOJQhozGB32fNcl1RVBKqdCf2AtCeOYArqbCop7YD85zmNRSdJCbbduCS25co4qioMb41Jh0lHabcdwSUuO0xDclGZSj4RZlvLDLPFkgbifzDVKyEgF5RyuVCprNpph5VzkSvk5esSixSxwQJQv/9Bd810pVOJNEFnPEeOOccUvf1SEaWt+CtZuBvZ+BW3h3sbCnjTOEw7WeW0R+4xbKnzMw9h6y7jmi/FSX/8nYc8YP+qc/QQ7ugWTvgMrr43f5by/I2DcetF+Crx/FNKQ4nBSMy0SSJCGZRqOBQqEgXppJ/hMRRg5cWzxIsVhEt9sVgfmbOfQJRpbQ8X+XPOXbH5NcSSTmXIduAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"12841dff.png\"\n        title=\"12841dff.png\"\n        src=\"/static/948ad3dc1af68c6957efab52d0751a4d/00d43/12841dff.png\"\n        srcset=\"/static/948ad3dc1af68c6957efab52d0751a4d/63868/12841dff.png 250w,\n/static/948ad3dc1af68c6957efab52d0751a4d/0b533/12841dff.png 500w,\n/static/948ad3dc1af68c6957efab52d0751a4d/00d43/12841dff.png 1000w,\n/static/948ad3dc1af68c6957efab52d0751a4d/c6ff8/12841dff.png 1088w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>本文将花更多精力对 <strong>Redux 源码体系</strong>进行学习理解。</p>\n<p>分为以下几个模块讲解：</p>\n<ul>\n<li>Redux 的设计思路及其实现原理</li>\n<li>Redux 中间件的设计思路及其实现原理</li>\n<li>Redux 社区常用中间件原理</li>\n<li>React-Redux 的设计思路及其实现原理</li>\n</ul>\n<h2 id=\"redux-的设计\" style=\"position:relative;\"><a href=\"#redux-%E7%9A%84%E8%AE%BE%E8%AE%A1\" aria-label=\"redux 的设计 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux 的设计</h2>\n<p>下载了 Redux 的源码，可以看到它的文件结构非常清晰：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB9klEQVQoz3WT246bMBRF+f+Pq9J0JiRcDQYb29jGGFL1afeYXCqNOg9LDhAt7XNxNnKLyyUHKyuocYTsOSTnmKSAnDQmwtkZlvCLg7ELnPfYtg33/X6wb/vxnMi0WXHLb2jyHNMw/IOESRTWgH60ENxANAqTcNDzgtFwsKmG8Rohhrc0M3OEFAIT6xBjRKQPkT7ENWKj55SmaC1YoVCfB7CrQMs0eiVxHc747E/oVINl9UfazM4bGB8wjoKEK0IIb+JTeCNhV5LwU4D3FnVfoewKjFocCefFwAULHxyymRIKKaGUOgRJtK4PcaTTeeoblehS7/QCbwNBv2dPPaX/rcshO6SLJSH1kA0GdcPgnXvLXmLnLJSmoXiL339oAPuG/b4/2R7P+07l7seZWRK2JKyaDguV91Xo/YKmYyhuJdq2hg4cdhewm3icX8icpR6OJKxbSJrsu2TikXCGYArViUPTtFOKNNHvyJxyqPIW+ekneHGFlyNCEmuF9RjKDF5JNL/oPfXsfn/u3P5/skVSunbC5VaD0/4FWpc1laymQ2idwdgqsJwmKt17gRMp7et8kfnJ4OP8QQl/0PLWmEZGt6WC7Eq6Fea4HbLTVPIAXk6HNBHjN0LnNgysRVcV8EY9oHJ9uiWU1JJUCINhUBB6oL1T36ZL/AV+koYjoJ+PzQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ed8bd691.png\"\n        title=\"ed8bd691.png\"\n        src=\"/static/3cdd554db1241b4bbe605ee960187f10/00d43/ed8bd691.png\"\n        srcset=\"/static/3cdd554db1241b4bbe605ee960187f10/63868/ed8bd691.png 250w,\n/static/3cdd554db1241b4bbe605ee960187f10/0b533/ed8bd691.png 500w,\n/static/3cdd554db1241b4bbe605ee960187f10/00d43/ed8bd691.png 1000w,\n/static/3cdd554db1241b4bbe605ee960187f10/aa440/ed8bd691.png 1500w,\n/static/3cdd554db1241b4bbe605ee960187f10/e8950/ed8bd691.png 2000w,\n/static/3cdd554db1241b4bbe605ee960187f10/7d62e/ed8bd691.png 2368w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>主要就这几个模块：</p>\n<ul>\n<li>createStore.js：初始化，创建 store</li>\n<li>combineReducers.js：组合 reducer 函数</li>\n<li>bindActionCreators.js： 绑定 actions</li>\n<li>applyMiddleware.js：组合中间件</li>\n<li>compose.js：将函数进行组合，服务于 applyMiddleware 模块，其核心作用</li>\n</ul>\n<p>下面会仔细讲解这几个模块，并从源码中抽离出核心运行模型，便于理解。</p>\n<h3 id=\"全局-store-的设计\" style=\"position:relative;\"><a href=\"#%E5%85%A8%E5%B1%80-store-%E7%9A%84%E8%AE%BE%E8%AE%A1\" aria-label=\"全局 store 的设计 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>全局 store 的设计</h3>\n<p>在 Redux 项目中，我们会有一个全局 store，也就是唯一数据源。先对其进行封装，描述出基本的骨架：</p>\n<blockquote>\n<p>注：以下所有的代码都来于 Redux 源码，为了方便理解，会精简删除非必要代码</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createStore</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reducer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *reducer 方法</span>\n    <span class=\"token keyword\">let</span> currentReducer <span class=\"token operator\">=</span> reducer\n    <span class=\"token comment\">// *state</span>\n    <span class=\"token keyword\">let</span> currentState <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n    <span class=\"token comment\">// *事件监听列表</span>\n    <span class=\"token keyword\">let</span> currentListeners <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">let</span> nextListeners <span class=\"token operator\">=</span> currentListeners\n\n    <span class=\"token comment\">// *状态管理方法</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">listener</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 生成初始状态</span>\n    <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> ActionTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">INIT</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 返回 store 对象</span>\n    <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      dispatch<span class=\"token punctuation\">,</span>\n      subscribe<span class=\"token punctuation\">,</span>\n      getState\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> store\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这个骨架中，核心在于这三个方法，定义了如何获取和改变 store 的路径：</p>\n<ul>\n<li>getState()</li>\n<li>dispatch()</li>\n<li>subscribe()</li>\n</ul>\n<p>下面一个个看：</p>\n<h3 id=\"getstate-的实现\" style=\"position:relative;\"><a href=\"#getstate-%E7%9A%84%E5%AE%9E%E7%8E%B0\" aria-label=\"getstate 的实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>getState 的实现</h3>\n<p>getState() 的设计最简单，其返回的是全局状态 currentState。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> currentState\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"subscribe-的实现\" style=\"position:relative;\"><a href=\"#subscribe-%E7%9A%84%E5%AE%9E%E7%8E%B0\" aria-label=\"subscribe 的实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>subscribe 的实现</h3>\n<p>subscribe() 的目的是添加 listener，然后在 dispatch 阶段 state 发生变化时可以执行一遍。这个有点类似于<a href=\"https://betamee.github.io/content/webfrontend-3159d12b99fb520a9c11583ccaabffb2\">观察者模式</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">listener</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 主要是添加进 listeners 数组中</span>\n  nextListeners<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 返回取消订阅的方法</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"dispatch-的实现\" style=\"position:relative;\"><a href=\"#dispatch-%E7%9A%84%E5%AE%9E%E7%8E%B0\" aria-label=\"dispatch 的实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>dispatch 的实现</h3>\n<p>在 Redux 中，我们要改变 store 数据，一般是通过传入具名的 action 对象，action 对象携带着相关的数据以及 actionType，根据 actionType，store 会修改对应的 state。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// action 对象</span>\n<span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'ADD_TODO'</span><span class=\"token punctuation\">,</span>\n  data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>dispatch() 中主要干两件事：</p>\n<ol>\n<li>调用 currentReducer 生成新的 state</li>\n<li>state 发生变化时，执行一遍 listeners</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. 调用 currentReducer 生成新的 state</span>\n  currentState <span class=\"token operator\">=</span> <span class=\"token function\">currentReducer</span><span class=\"token punctuation\">(</span>currentState<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 2. 当 state 发生变化时，执行一遍 listeners</span>\n  <span class=\"token keyword\">const</span> listeners <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>currentListeners <span class=\"token operator\">=</span> nextListeners<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> listeners<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> listener <span class=\"token operator\">=</span> listeners<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    <span class=\"token function\">listener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> action\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>currentReducer 函数是在创建 store 时候传进来的，是自定义的改变 store 中数据的方法，要求必须是<strong>纯函数</strong>，返回的是全新的 state。</p>\n<p>创建一个 reducer.js 文件，在这里根据业务需求更新数据：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">todoReducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state <span class=\"token operator\">=</span> initalState<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">ADD_TODO</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n        todo<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span>data\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> state\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"基本运行模型总结\" style=\"position:relative;\"><a href=\"#%E5%9F%BA%E6%9C%AC%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%80%BB%E7%BB%93\" aria-label=\"基本运行模型总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>基本运行模型总结</h3>\n<p>到这一步，整个 Redux 运行的基本模型就讲清楚了。对应源码 <em>createStore.js</em>，主要就上面三个方法的实现。当然，Redux 本身不止这么简单，它的精华来源于<strong>中间件设计</strong>，这是下一节要分析的主题。</p>\n<p>下面的 demo 用来总结 Redux 的基本使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> reducer <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./reducer'</span>\n\n<span class=\"token comment\">// 创建store</span>\n<span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 订阅通知</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'组件1收到 store 的通知'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'组件2收到 store 的通知'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 执行 dispatch，触发 store 的通知</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n   type<span class=\"token operator\">:</span> <span class=\"token string\">'add_todo'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"redux-中的概念与术语\" style=\"position:relative;\"><a href=\"#redux-%E4%B8%AD%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%9C%AF%E8%AF%AD\" aria-label=\"redux 中的概念与术语 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux 中的概念与术语</h3>\n<p>这里整理一下 Redux 中会用到的一些概念：</p>\n<ul>\n<li>Store: 全局唯一，用于存储 state，以及相应的更新方法</li>\n<li>Actions: 一个带有 type 字段的纯对象，描述应用应该发生了些什么变化</li>\n<li>Action Creator： 生成 Actions 的函数，有同步和异步两种，同步的返回一个 Actions 对象，异步的是返回一个函数</li>\n<li>Reducers：纯函数，接收 state 和 action，返回一个全新的 state</li>\n<li>Dispatch: Redux 内部用于更新的唯一方法，它会调用 reducer 函数</li>\n<li>Selectors：用于获取 state 中的某一个层级的值，随着应用 state 的变大变深，有利于减少重复逻辑</li>\n</ul>\n<h2 id=\"redux-中间件的设计思路及其实现原理\" style=\"position:relative;\"><a href=\"#redux-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86\" aria-label=\"redux 中间件的设计思路及其实现原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux 中间件的设计思路及其实现原理</h2>\n<p>如果没有中间件的加持的话，只依赖上面所分析的 Redux 代码，我们所用到的不过就是使用一个外部的 store 存取数据，并没有体现 Redux 有多么大的优势。</p>\n<p>正是因为有了中间件，我们可以在数据的流通过程中实现很多新的功能。中间件可以理解为拦截器，是在 dispatch 到 reducer 过程中，对数据进行修改，从而增强 dispatch 的功能。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQY07WR3Q4BMRCF+/4PZLOWtdYVcSGE/UWIrEh4gs70mG2REsSNSU46Z/pNmuYoYoNWbNypb97OvP7O8Ks3z17hUeZHfS+VVIS4JMwbxqIh9KUfyGyyY2zObH1aE5La+WHdynHbC2MsXMv3CsLyyFBxqdHNNaZ7sgozgQuN0ZpRnBjBSh4QJsxJPCGSxaTSCDKy96lwkex3hJsd+A9ffheKH4z25AfwKaQrQNnOqiJZEMAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"d6632dc4.png\"\n        title=\"d6632dc4.png\"\n        src=\"/static/a19202523222375a600bd4e4eb4f0ac0/00d43/d6632dc4.png\"\n        srcset=\"/static/a19202523222375a600bd4e4eb4f0ac0/63868/d6632dc4.png 250w,\n/static/a19202523222375a600bd4e4eb4f0ac0/0b533/d6632dc4.png 500w,\n/static/a19202523222375a600bd4e4eb4f0ac0/00d43/d6632dc4.png 1000w,\n/static/a19202523222375a600bd4e4eb4f0ac0/21b4d/d6632dc4.png 1280w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"常规中间件的成型\" style=\"position:relative;\"><a href=\"#%E5%B8%B8%E8%A7%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%88%90%E5%9E%8B\" aria-label=\"常规中间件的成型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>常规中间件的成型</h3>\n<p>用下面的例子来一步一步讲解中间件是如何形成的：</p>\n<ol>\n<li>在每次 dispatch 之后手动打印 store 的内容。</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// action { type: 'plus' }</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>这种方式简单直接，但不符合封装的要求。</p>\n<ol start=\"2\">\n<li>封装 dispatch</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndLog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>通过封装为一个方法，达到可复用的要求。</p>\n<ol start=\"3\">\n<li>替换 dispatch</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\nstore<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndLog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>把原来的 dispatch 函数提出来，命为 next，然后替换 store.dispatch，加上自定义的功能。</p>\n<ol start=\"4\">\n<li>模块化</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 打印日志中间件</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n    store<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndLog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 监控错误中间件</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">crashReport</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 这里取到的 dispatch 已经是被上一个中间件包装过的 dispatch, 从而实现中间件串联</span>\n    <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n    store<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndReportErrors</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> result\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>随着功能模块的的增多，我们需要<strong>独立的可拔插的</strong>模块。不同的模块拆分成不同方法，通过<strong>在方法内获取上一个中间件包装过的 store.dispatch 实现链式调用</strong>。然后我们就能通过调用这些中间件方法，分别使用、组合这些中间件。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 内部已经实现链式调用了</span>\n<span class=\"token function\">logger</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span>\n<span class=\"token function\">crashReport</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span></code></pre></div>\n<ol start=\"5\">\n<li>组合中间件</li>\n</ol>\n<p>有了多个中间件模块后，最终要组合成一起，按顺序调用。提供一个 applyMiddleware 的方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store<span class=\"token punctuation\">,</span> middlewares</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    middlewares <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">...</span>middlewares <span class=\"token punctuation\">]</span> \n    <span class=\"token comment\">// 由于循环替换 dispatch 时,前面的中间件在最里层,因此需要翻转数组才能保证中间件的调用顺序</span>\n    middlewares<span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>                     \n    <span class=\"token comment\">// 循环替换 dispatch   </span>\n    middlewares<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">middleware</span> <span class=\"token operator\">=></span>      \n        store<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token function\">middleware</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span>    \n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>稍微改造一下上面的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger enter'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 之前的做法(在方法内直接替换 dispatch):</span>\n    <span class=\"token comment\">// store.dispatch = function dispatchAndLog(action) { ... }</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndLog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger out'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">crashReport</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 这里取到的 dispatch 已经是被上一个中间件包装过的 dispatch, 从而实现中间件串联    </span>\n    <span class=\"token keyword\">let</span> next <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crashReport enter'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// store.dispatch = function dispatchAndReportErrors(action) { ... }</span>\n    \n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchAndReportErrors</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>        \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>        \n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crashReport out'</span><span class=\"token punctuation\">)</span>      \n            <span class=\"token keyword\">return</span> result\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>            \n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>            \n        <span class=\"token punctuation\">}</span>    \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样就可以以下面的形式使用中间件：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>crashReport<span class=\"token punctuation\">,</span> logger<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 中间件调用顺序：logger -> crashReport</span>\n<span class=\"token comment\">// 打印顺序：</span>\n<span class=\"token comment\">// logger enter -> crashReport enter -> crashReport out -> logger out</span></code></pre></div>\n<h3 id=\"函数式编程改造中间件和-applymiddleware-模块\" style=\"position:relative;\"><a href=\"#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%94%B9%E9%80%A0%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%92%8C-applymiddleware-%E6%A8%A1%E5%9D%97\" aria-label=\"函数式编程改造中间件和 applymiddleware 模块 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>函数式编程改造中间件和 applyMiddleware 模块</h3>\n<p>上面的例子基本上已经成型了，但也有一些问题，这些函数不够“纯”，直接在函数内部改动 store.dispatch，造成不可预期的副作用。从<strong>函数式编程</strong>的思想出发，我们将中间件柯里化：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger enter'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>        \n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger out'</span><span class=\"token punctuation\">)</span>      \n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">crashReport</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crashReport enter'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crashReport out'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后改造 applyMiddleware：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>funcs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>funcs<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> arg\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>funcs<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> funcs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> funcs<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token function\">b</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>middlewares</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">createStore</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reducer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// *这个变量是临时的，会被下面的 dispatch 覆盖，所以不要迷惑</span>\n        <span class=\"token comment\">// *之所以这样弄，是为了防止中间件组合阶段没有成功，报个错</span>\n        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">'Dispatching while constructing your middleware is not allowed. '</span> <span class=\"token operator\">+</span>\n                <span class=\"token string\">'Other middleware would not be applied to this dispatch.'</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">const</span> middlewareAPI <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            getState<span class=\"token operator\">:</span> store<span class=\"token punctuation\">.</span>getState<span class=\"token punctuation\">,</span>\n            <span class=\"token comment\">// *这里不直接使用 dispatch(action, ...args)，是因为闭包原因，防止共享一个 dispatch</span>\n            <span class=\"token function-variable function\">dispatch</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">action<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// *使用 compose 来组合</span>\n        <span class=\"token keyword\">const</span> chain <span class=\"token operator\">=</span> middlewares<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">middleware</span> <span class=\"token operator\">=></span> <span class=\"token function\">middleware</span><span class=\"token punctuation\">(</span>middlewareAPI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 覆盖上面的 dispatch 变量</span>\n        dispatch <span class=\"token operator\">=</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>chain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">.</span>dispatch<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>store<span class=\"token punctuation\">,</span>\n            dispatch\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里做了两处改动：</p>\n<ol>\n<li>使用 compose 方法取代了 middlewares.reverse()，compose 是函数式编程中常用的一种组合函数的方式，compose 内部使用 reduce 巧妙地组合了中间件函数，使传入的中间件形式 compose(f, g, h) 变成 (...args) => f(g(h(...args))) 这种形式</li>\n<li>不直接替换 dispatch，而是作为高阶函数增强 createStore，最后 return 的是一个新的 store</li>\n</ol>\n<p>最后是 createStore 需要兼容中间件模式：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createStore</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reducer<span class=\"token punctuation\">,</span> enhancer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> enhancer <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> enhancer <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *函数式思想增强 createStore，enhancer 是中间件增强</span>\n    <span class=\"token comment\">// return enhancer(createStore)(reducer)</span>\n    <span class=\"token comment\">// vs.</span>\n    <span class=\"token comment\">// return createStore(reducer)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">enhancer</span><span class=\"token punctuation\">(</span>createStore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// *reducer 方法</span>\n  <span class=\"token keyword\">let</span> currentReducer <span class=\"token operator\">=</span> reducer\n  <span class=\"token comment\">// *state</span>\n  <span class=\"token keyword\">let</span> currentState <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n  <span class=\"token comment\">// *事件监听列表</span>\n  <span class=\"token keyword\">let</span> currentListeners <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">let</span> nextListeners <span class=\"token operator\">=</span> currentListeners\n\n  <span class=\"token comment\">// *状态管理方法</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">listener</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 生成初始状态</span>\n  <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> ActionTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">INIT</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 返回 store 对象</span>\n  <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dispatch<span class=\"token punctuation\">,</span>\n    subscribe<span class=\"token punctuation\">,</span>\n    getState\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> store\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这样，整个中间件的模型就跑通了。</p>\n<p>请记住中间件的三层参数：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mid</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里的参数 store 指向 middlewareAPI 变量，包含用于获取当前状态的 store.getState 和一个 compose 各种中间件后生成的 dispatch 方法，它能让初始的 store.dispatch 在中间件中进行流通，在最后一层得到调用。</p>\n<p>能让这一切组合起来并执行的核心是 <em>applyMiddleware</em> 函数，理解了这个模块，也就理解了 Redux 中间件的原理。</p>\n<h3 id=\"洋葱圈模型\" style=\"position:relative;\"><a href=\"#%E6%B4%8B%E8%91%B1%E5%9C%88%E6%A8%A1%E5%9E%8B\" aria-label=\"洋葱圈模型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>洋葱圈模型</h3>\n<p>我们巧妙的发现了一个事实，<em>applyMiddleware</em> 中使用了 <em>compose</em> 函数，而在<a href=\"https://betamee.github.io/content/node-a5532de364345732a2fb4008eddd8cc7\">Koa 体系详解</a> 一文中，我也整理到了 Koa 中间件也使用了 <em>compose</em> 函数，形成了所谓的<strong>洋葱圈模型</strong>。那么这里 Redux 中间件同理，执行顺序异曲同工：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger1</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'进入log1'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'离开log1'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger2</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'进入log2'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'离开log2'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger3</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'进入log3'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'离开log3'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>代码执行结果：<em>进入log1 -> 进入log2 -> 进入log3 -> 离开log3 -> 离开log2 -> 离开log1</em></p>\n<p>代码执行路径：<em>进入log1 -> 执行next -> 进入log2 -> 执行next -> 进入log3 -> 执行next -> next执行完毕 -> 离开log3 -> 回到上一层中间件,执行上层中间件next之后的语句 -> 离开log2 -> 回到中间件log1, 执行log1的next之后的语句 -> 离开log1</em></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQ4y32TUXOCQAyE/f+/r31oHyqtSBURBRFQkXS/1GMQW28mk+PIbTab3Mwmq+/7hz3+fD4PNv4/jsFm/wEGf7lcrKoqq+vajX1ZlnY8Hh9iHwCnAW3bOsD1erWu6xz8dDr5+eFwsCzLPMn4zuwZGCxYXGqaxs/wJMnz3Pe73c4TPmUImziObbVa2Xq99j2X0zS1zWbjgLAFlGSwvQMMggZAArmw3W7dF0XhugEeRZEnolyYcY4hxZ8ljxtAyXhYUe7p1mUYwTZoSRxJB8CxfmSj5PIWEM3n9vb+bkU0t3qbWb7fWy7d9vIkAgzj3gMgQDCglFolFKWyfwpIEvT6Vwkk077a5ZYmiQMDhjRDydPh7DAuqxEbaXZRAs5DJ73rq29bvL5YK31hhp5ofadhWNniy1KBdWLBCmPSSEvYV2KULGM7RB9+ztjcddmzi9EVj/DJ0jrR7xTgr0HMguiYA9A4xRXSdK+zu5dCVsYgkSZLsYvlGQ0YUSYsiAkvpBXjhk7HCytk3WRKBg25HIzvMDp8D2BUoH0t0DLXjH4nz9/ydCF0mMUAiKaNvAGi//0v0gD6A2A+kcd5i/cEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"737d7fed.png\"\n        title=\"737d7fed.png\"\n        src=\"/static/374561d40e7b37047f2bf24337bc2913/00d43/737d7fed.png\"\n        srcset=\"/static/374561d40e7b37047f2bf24337bc2913/63868/737d7fed.png 250w,\n/static/374561d40e7b37047f2bf24337bc2913/0b533/737d7fed.png 500w,\n/static/374561d40e7b37047f2bf24337bc2913/00d43/737d7fed.png 1000w,\n/static/374561d40e7b37047f2bf24337bc2913/c425d/737d7fed.png 1279w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"异步中间件\" style=\"position:relative;\"><a href=\"#%E5%BC%82%E6%AD%A5%E4%B8%AD%E9%97%B4%E4%BB%B6\" aria-label=\"异步中间件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>异步中间件</h3>\n<p>上面讲解了 Redux 常规的中间件是如何一步步成型的，这种中间件都是同步代码，但有的时候我们需要处理一些异步操作，比如网络请求数据、使用 Promise 等<strong>异步场景</strong>，这些就无法使用常规中间件了，那么该如何解决这个问题。</p>\n<p>Redux 社区中有不少知名的模块可以帮我们解决问题，如</p>\n<ul>\n<li><a href=\"https://github.com/reduxjs/redux-thunk\">Redux-Thunk</a></li>\n<li><a href=\"https://redux-saga.js.org/\">Redux-Saga</a></li>\n<li><a href=\"https://github.com/redux-utilities/redux-promise\">Redux Promsie</a></li>\n</ul>\n<p>下面来一个个分析其原理。</p>\n<h4 id=\"redux-thunk\" style=\"position:relative;\"><a href=\"#redux-thunk\" aria-label=\"redux thunk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>redux-thunk</h4>\n<p>thunk 中间件源码非常简单：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 创建中间件，extraArgument 能带给 action 函数一些额外的参数</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createThunkMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">extraArgument</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> dispatch<span class=\"token punctuation\">,</span> getState <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果 action 是函数类型，直接执行</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> action <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">,</span> getState<span class=\"token punctuation\">,</span> extraArgument<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 如果 action 是对象，则传递给下一个中间件</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> thunk <span class=\"token operator\">=</span> <span class=\"token function\">createThunkMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nthunk<span class=\"token punctuation\">.</span>withExtraArgument <span class=\"token operator\">=</span> createThunkMiddleware<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> thunk<span class=\"token punctuation\">;</span></code></pre></div>\n<p>它内部对 action 多了一层判断：</p>\n<ul>\n<li>如果 action 是函数，则传入 dispatch getState 参数，直接执行</li>\n<li>如果 action 是对象，则调用 next(action) 传入下一层中间件</li>\n</ul>\n<p>在使用上，比起同步 Action Creator 多一层函数（案例来自 Redux-Thunk 的官网）：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createStore<span class=\"token punctuation\">,</span> applyMiddleware <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'redux'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> thunk <span class=\"token keyword\">from</span> <span class=\"token string\">'redux-thunk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> rootReducer <span class=\"token keyword\">from</span> <span class=\"token string\">'./reducers'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 创建 store</span>\n<span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>rootReducer<span class=\"token punctuation\">,</span> <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span>thunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 同步 Action Creator</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeASandwich</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">forPerson<span class=\"token punctuation\">,</span> secretSauce</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">'MAKE_SANDWICH'</span><span class=\"token punctuation\">,</span>\n    forPerson<span class=\"token punctuation\">,</span>\n    secretSauce<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">apologize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fromPerson<span class=\"token punctuation\">,</span> toPerson<span class=\"token punctuation\">,</span> error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">'APOLOGIZE'</span><span class=\"token punctuation\">,</span>\n    fromPerson<span class=\"token punctuation\">,</span>\n    toPerson<span class=\"token punctuation\">,</span>\n    error<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">withdrawMoney</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">amount</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">'WITHDRAW'</span><span class=\"token punctuation\">,</span>\n    amount<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 异步 Action Creator</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">forPerson</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 返回的是一个 thunk 函数</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dispatch<span class=\"token punctuation\">,</span> getState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 发起请求获取数据</span>\n      <span class=\"token keyword\">const</span> sauce <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'...'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwich</span><span class=\"token punctuation\">(</span>forPerson<span class=\"token punctuation\">,</span> sauce<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">apologize</span><span class=\"token punctuation\">(</span><span class=\"token string\">'The Sandwich Shop'</span><span class=\"token punctuation\">,</span> forPerson<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> \n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 通过 store 发起数据 dispatch</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Me'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 甚至还能接收 thunk 函数的返回值，因为 thunk 中返回了 Promise value</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'My partner'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Done!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 还可以组合多个异步 Action Creator</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeSandwichesForEverybody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dispatch<span class=\"token punctuation\">,</span> getState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>sandwiches<span class=\"token punctuation\">.</span>isShopOpen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 下面 dispatch 的既可以是异步 Action Creator，也可以是同步 Action Creator</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 多层异步 Action Creator</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'My Grandma'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n          <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Me'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'My wife'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeASandwichWithSecretSauce</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Our kids'</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// 同步 Action Creator</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>\n          <span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>myMoney <span class=\"token operator\">></span> <span class=\"token number\">42</span>\n            <span class=\"token operator\">?</span> <span class=\"token function\">withdrawMoney</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">:</span> <span class=\"token function\">apologize</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Me'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'The Sandwich Shop'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 可以方便服务端渲染</span>\nstore\n  <span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">makeSandwichesForEverybody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>MyApp store<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>store<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>thunk 函数中，如果需要一些额外的参数传递，可以这样使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> api <span class=\"token operator\">=</span> <span class=\"token string\">\"http://www.example.com/sandwiches/\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> whatever <span class=\"token operator\">=</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>\n  reducer<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 在创建 thunk 中间件的时候，传递一些额外的参数</span>\n  <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span>thunk<span class=\"token punctuation\">.</span><span class=\"token function\">withExtraArgument</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> api<span class=\"token punctuation\">,</span> whatever <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 异步 Action Creator</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">fetchUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dispatch<span class=\"token punctuation\">,</span> getState<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> api<span class=\"token punctuation\">,</span> whatever <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ....</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"redux-soga\" style=\"position:relative;\"><a href=\"#redux-soga\" aria-label=\"redux soga permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>redux-soga</h4>\n<p>（未完待续...学不动了.jpg）</p>\n<h2 id=\"redux-的辅助模块-combinereducers-和-bindactioncreators\" style=\"position:relative;\"><a href=\"#redux-%E7%9A%84%E8%BE%85%E5%8A%A9%E6%A8%A1%E5%9D%97-combinereducers-%E5%92%8C-bindactioncreators\" aria-label=\"redux 的辅助模块 combinereducers 和 bindactioncreators permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux 的辅助模块 combineReducers 和 bindActionCreators</h2>\n<p>在实际项目中，我们会根据场景拆分 reducer 和 action 进多个文件，这就需要 <strong>combineReducers.js</strong> 和 <strong>bindActionCreators.js</strong>。从字面意思上就能看出，这两个源码模块是整合 reducer 和 action 函数。我把它定位为是辅助 Redux 体系的工具函数。</p>\n<p>让我们来看看它是如何被设计出来的：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// combineReducers.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reducers</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *获取 key 数组</span>\n    <span class=\"token keyword\">const</span> reducerKeys <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>reducers<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> finalReducers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> reducerKeys<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> reducerKeys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n      <span class=\"token comment\">// *如果 reducers[key] 为函数，则放入 finalReducers 中</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> reducers<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        finalReducers<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> reducers<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// *？？ 其实只是复制了一下，干了个寂寞</span>\n    <span class=\"token keyword\">const</span> finalReducerKeys <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>finalReducers<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// *返回一个 combination 组合函数</span>\n    <span class=\"token comment\">// *参数： newstate, newaction</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">combination</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> hasChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n      <span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// *对 finalReducerKeys 进行循环</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> finalReducerKeys<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// *读取 reducer</span>\n        <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> finalReducerKeys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">const</span> reducer <span class=\"token operator\">=</span> finalReducers<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n        <span class=\"token comment\">// *获取 previousStateForKey</span>\n        <span class=\"token keyword\">const</span> previousStateForKey <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n        <span class=\"token comment\">// *使用 previousStateForKey + action => nextStateForKey</span>\n        <span class=\"token comment\">// *这里有一个问题，每一个 action 都会走一遍所有的 render，即使有些 action 不属于对应的 reducer</span>\n        <span class=\"token keyword\">const</span> nextStateForKey <span class=\"token operator\">=</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span>previousStateForKey<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// *覆盖原来的 key 的位置</span>\n        nextState<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nextStateForKey\n        <span class=\"token comment\">// *是否发生变化：</span>\n        <span class=\"token comment\">// *nextStateForKey !== previousStateForKey 这是因为如果 reducer 返回默认 state，两者就会一致</span>\n        hasChanged <span class=\"token operator\">=</span> hasChanged <span class=\"token operator\">||</span> nextStateForKey <span class=\"token operator\">!==</span> previousStateForKey\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// *最终判定是否改变：如果 hasChanged 为true 或者单纯的传入的 state keys length 不等于 finalReducerKeys.length</span>\n      hasChanged <span class=\"token operator\">=</span> hasChanged <span class=\"token operator\">||</span> finalReducerKeys<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!==</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length\n      <span class=\"token comment\">// *返回新 state</span>\n      <span class=\"token keyword\">return</span> hasChanged <span class=\"token operator\">?</span> nextState <span class=\"token operator\">:</span> state\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>combineReducers 函数其实是将多个 reducer 合成一个统一的 reducer，它是这样的步骤：</p>\n<ol>\n<li>循环生成一个全新的 finalReducers 对象，里面是 (k, v) 一一对应的 sub state render</li>\n<li>\n<p>循环 finalReducers 对象，对每一个 sub state render 都会调用 render(action)，覆盖生成一个 total state tree 对象。分两种情况：</p>\n<ul>\n<li>如果 sub state render 匹配 action，则会生成新的 sub state</li>\n<li>其他不匹配的则返回 default state</li>\n</ul>\n</li>\n<li>\n<p>这样生成了新的 total state tree，里面的 (k, v) 一一对应 sub state</p>\n<ul>\n<li>只有得到更新的 sub state 是全新对象</li>\n<li>没有得到更新的 sub state 还是原来的引用</li>\n</ul>\n</li>\n</ol>\n<p>但 combineReducers 也有问题，每发起一个 action 会将所有的 reducer 都过一遍，即使这个 action 只对应某一个 reducer。这也就造成了性能的浪费。（下面的 redux-ignore 会解决这个问题）</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">combineReducers<span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    potato: potatoReducer,\n    tomato: tomatoReducer\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> combination<span class=\"token punctuation\">(</span>state, action<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n   potato: <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">}</span>,\n   tomato: <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>下面是 bindActionCreators 源码：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// bindActionCreators.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">bindActionCreator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">actionCreator<span class=\"token punctuation\">,</span> dispatch</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *包一层调用 dispatch 的函数</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">actionCreator</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bindActionCreators</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">actionCreators<span class=\"token punctuation\">,</span>\n    dispatch</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> actionCreators <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">bindActionCreator</span><span class=\"token punctuation\">(</span>actionCreators<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> boundActionCreators <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> key <span class=\"token keyword\">in</span> actionCreators<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> actionCreator <span class=\"token operator\">=</span> actionCreators<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> actionCreator <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        boundActionCreators<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">bindActionCreator</span><span class=\"token punctuation\">(</span>actionCreator<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> boundActionCreators\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>bindActionCreator 比较简单，它是将所有的 action creator 生成一个新的包裹函数：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">bindActionCreators(\n  {\n    () => ({}), // 普通 Action Creator\n    () => (dispatch, getState) => {} // 异步 Action Creator\n  },\n  dispatch\n)\n=> bindActionCreator(actionCreator, dispatch)\n=> (this, ...args) => {\n  // 包裹一层 dispatch 的函数\n  return dispatch(actionCreator.apply(this, args))\n}</code></pre></div>\n<h2 id=\"react-redux-的设计\" style=\"position:relative;\"><a href=\"#react-redux-%E7%9A%84%E8%AE%BE%E8%AE%A1\" aria-label=\"react redux 的设计 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>React-Redux 的设计</h2>\n<p>源码有点多，另起炉灶写一篇...</p>\n<h2 id=\"相关库使用及其原理\" style=\"position:relative;\"><a href=\"#%E7%9B%B8%E5%85%B3%E5%BA%93%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%85%B6%E5%8E%9F%E7%90%86\" aria-label=\"相关库使用及其原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>相关库使用及其原理</h2>\n<p>这个章节，简单分析两个 Redux 社区中常见的库，因为源码比较简单，直接拿来分析。有些比较复杂的库比如 immer.js、normalizr.js，后续会开专门的文章来分析讲解。</p>\n<h3 id=\"reselectjs\" style=\"position:relative;\"><a href=\"#reselectjs\" aria-label=\"reselectjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>reselect.js</h3>\n<p>reselect 是一个缓存 selector 函数结果的库。</p>\n<p>在 Redux 中，我们在把 state 传递给 React 组件之前，一般会根据业务场景 <strong>select</strong> 出一些合适的数据：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getVisibleTodos</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">todos<span class=\"token punctuation\">,</span> filter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'SHOW_ALL'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> todos\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'SHOW_COMPLETED'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> todos<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'SHOW_ACTIVE'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> todos<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span>t<span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    todos<span class=\"token operator\">:</span> <span class=\"token function\">getVisibleTodos</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>todos<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">.</span>visibilityFilter<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapDispatchToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dispatch</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">onTodoClick</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">toggleTodo</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> VisibleTodoList <span class=\"token operator\">=</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  mapStateToProps<span class=\"token punctuation\">,</span>\n  mapDispatchToProps\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>TodoList<span class=\"token punctuation\">)</span></code></pre></div>\n<p>但这里会有一个问题，每次组件渲染，这些 selector 函数都会执行一遍。本质上，这些 selector 都是纯函数，如果前后参数一致的情况下，执行的结果都是一样的。我们需要在这里进行性能优化，如果<strong>前后参数一致的情况下，则直接返回缓存结果</strong>，这就是 reselect 的作用：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createSelector <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'reselect'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">shopItemsSelector</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> state<span class=\"token punctuation\">.</span>shop<span class=\"token punctuation\">.</span>items\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">taxPercentSelector</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> state<span class=\"token punctuation\">.</span>shop<span class=\"token punctuation\">.</span>taxPercent\n\n<span class=\"token keyword\">const</span> subtotalSelector <span class=\"token operator\">=</span> <span class=\"token function\">createSelector</span><span class=\"token punctuation\">(</span>\n  shopItemsSelector<span class=\"token punctuation\">,</span>\n  <span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> items<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">subtotal<span class=\"token punctuation\">,</span> item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> subtotal <span class=\"token operator\">+</span> item<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> taxSelector <span class=\"token operator\">=</span> <span class=\"token function\">createSelector</span><span class=\"token punctuation\">(</span>\n  subtotalSelector<span class=\"token punctuation\">,</span>\n  taxPercentSelector<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">subtotal<span class=\"token punctuation\">,</span> taxPercent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> subtotal <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>taxPercent <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">taxSelector</span><span class=\"token punctuation\">(</span>exampleState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 0.172</span></code></pre></div>\n<p>reselect.js 精简后的源码：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createSelectorCreator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">memoize<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>memoizeOptions</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *返回一个接收 funcs 数组的函数</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>funcs</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> recomputations <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token comment\">// * pop 出最后一个函数，剩下的都是依赖</span>\n        <span class=\"token keyword\">const</span> resultFunc <span class=\"token operator\">=</span> funcs<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// *获取依赖，Function[]</span>\n        <span class=\"token keyword\">const</span> dependencies <span class=\"token operator\">=</span> <span class=\"token function\">getDependencies</span><span class=\"token punctuation\">(</span>funcs<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// *生成缓存函数</span>\n        <span class=\"token keyword\">const</span> memoizedResultFunc <span class=\"token operator\">=</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// *每次执行就++</span>\n            recomputations<span class=\"token operator\">++</span>\n            <span class=\"token comment\">// *执行最后一个函数</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">resultFunc</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>memoizeOptions\n        <span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// *如果一个 selector 每次调用的都是同一个参数，则无需再执行后面的</span>\n        <span class=\"token keyword\">const</span> selector <span class=\"token operator\">=</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">const</span> length <span class=\"token operator\">=</span> dependencies<span class=\"token punctuation\">.</span>length\n\n            <span class=\"token comment\">// *将依赖存入 params 中</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                params<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>dependencies<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// *给的是一个参数列表，注意 apply 是接收数组形式</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">memoizedResultFunc</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        selector<span class=\"token punctuation\">.</span>resultFunc <span class=\"token operator\">=</span> resultFunc\n        selector<span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> dependencies\n        <span class=\"token comment\">// *recomputations 参数可以得知函数是否被调用，缓存的情况下是不会被调用的</span>\n        selector<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">recomputations</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> recomputations\n        selector<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">resetRecomputations</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> recomputations <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token keyword\">return</span> selector\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> createSelector <span class=\"token operator\">=</span> <span class=\"token comment\">/* #__PURE__ */</span> <span class=\"token function\">createSelectorCreator</span><span class=\"token punctuation\">(</span>defaultMemoize<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 使用</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">shopItemsSelector</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> state<span class=\"token punctuation\">.</span>shop<span class=\"token punctuation\">.</span>items\n<span class=\"token keyword\">const</span> subtotalSelector <span class=\"token operator\">=</span> <span class=\"token function\">createSelector</span><span class=\"token punctuation\">(</span>\n  shopItemsSelector<span class=\"token punctuation\">,</span>\n  <span class=\"token parameter\">items</span> <span class=\"token operator\">=></span> items<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">subtotal<span class=\"token punctuation\">,</span> item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> subtotal <span class=\"token operator\">+</span> item<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>先简单理一下 <em>createSelectorCreator</em> 工厂函数的思路：</p>\n<ol>\n<li>调用 createSelectorCreator(defaultMemoize) 生成 createSelector</li>\n<li>\n<p>createSelector 接收一个 func list，其中最后一个函数的参数依赖之前函数返回的结果，这里会有一些步骤</p>\n<ul>\n<li>获取 dependencies 依赖函数列表</li>\n<li>对 func list 最后一个函数设为 resultFunc，并使用 memoize 包裹，表明是需要缓存优化的</li>\n<li>再使用 memoize 包裹一个新的函数，这个才是 selector</li>\n<li>\n<p>也即是初始化 const selectorForState = createSelector(...dependencyFuncs, resultFunc) 后，内部会有两层 memoize</p>\n<ul>\n<li>第一层：入口参数如果前后一致，则返回缓存结果</li>\n<li>第二层：调用 dependencyFuncs 后形成的参数，如果前后一致，则返回缓存结果</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p>而缓存的核心在于 <em>defaultMemoize</em> 函数：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// *默认相等比较，=== 比较</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">defaultEqualityCheck</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a <span class=\"token operator\">===</span> b\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// *参数浅比较相等</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">areArgumentsShallowlyEqual</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">equalityCheck<span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// *预先比较</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prev <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> next <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> prev<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!==</span> next<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// *使用 for-loop 可以尽早判断，不符合的情况下可以 drop</span>\n  <span class=\"token keyword\">const</span> length <span class=\"token operator\">=</span> prev<span class=\"token punctuation\">.</span>length\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">equalityCheck</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// *默认的缓存函数</span>\n<span class=\"token comment\">// *简单来说：如果前后两个参数不等，则直接返回原来的结果</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">defaultMemoize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">func<span class=\"token punctuation\">,</span> equalityCheck <span class=\"token operator\">=</span> defaultEqualityCheck</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> lastArgs <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">let</span> lastResult <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *如果之前的参数 lastArgs 和 新的参数不等</span>\n    <span class=\"token comment\">// *则调用 func，赋值 lastResult</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">areArgumentsShallowlyEqual</span><span class=\"token punctuation\">(</span>equalityCheck<span class=\"token punctuation\">,</span> lastArgs<span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      lastResult <span class=\"token operator\">=</span> <span class=\"token function\">func</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// *保留之前的参数</span>\n    lastArgs <span class=\"token operator\">=</span> arguments\n    <span class=\"token keyword\">return</span> lastResult\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Memoize 原理非常简单：</p>\n<ol>\n<li>第一次调用缓存参数和结果</li>\n<li>\n<p>第二次比较上一次和这次的参数，是否一致</p>\n<ul>\n<li>一致：返回上次结果，不去执行原函数</li>\n<li>不一致：执行原函数，并缓存新的参数和结果</li>\n</ul>\n</li>\n</ol>\n<p>可以看到，<em>equalityCheck</em> 的实现只是 a === b 这样的浅比较，当然也可以自定义使用比如 lodash.isEqual 这样深比较方式。</p>\n<p>下面的例子实际讲解结合 redux 的细节，比如我们有一个复杂的 state 树:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> exampleState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// shop sub state 对应 shop render</span>\n  shop<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    taxPercent<span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    items<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// snacks sub state 对应 snacks render</span>\n  snacks<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    items<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当有一个更新 shop 的 action 发出，根据前文 combineReducers 函数的原理，它只会更新 shop 这个子对象，生成新的引用，而 snacks 这个引用不会有啥变化，所以这种情况下，用到 snacks 的 selector 函数前后引用就会一致，会被缓存。但是用到 shop 下面的数据的 selector 前后参数引用（===浅比较）就会发生变化，进而重新执行一遍。</p>\n<p>但需要注意的，selector 函数如果引入其他参数如组件的 prop，就需要注意这个 selector 函数实例是否被<strong>共享</strong>了：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// getVisibleTodos.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getVisibilityFilter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  state<span class=\"token punctuation\">.</span>todoLists<span class=\"token punctuation\">[</span>props<span class=\"token punctuation\">.</span>listId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>visibilityFilter\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getTodos</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  state<span class=\"token punctuation\">.</span>todoLists<span class=\"token punctuation\">[</span>props<span class=\"token punctuation\">.</span>listId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>todos\n\n<span class=\"token keyword\">const</span> getVisibleTodos <span class=\"token operator\">=</span> <span class=\"token function\">createSelector</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">[</span> getVisibilityFilter<span class=\"token punctuation\">,</span> getTodos <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">visibilityFilter<span class=\"token punctuation\">,</span> todos</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> getVisibleTodos</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// VisibleTodoList.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 这个 getVisibleTodos 不会被正确缓存优化</span>\n    todos<span class=\"token operator\">:</span> <span class=\"token function\">getVisibleTodos</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapDispatchToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dispatch</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> VisibleTodoList <span class=\"token operator\">=</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  mapStateToProps<span class=\"token punctuation\">,</span>\n  mapDispatchToProps\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>TodoList<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> VisibleTodoList</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// App.jsx</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">App</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>VisibleTodoList listId<span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>VisibleTodoList listId<span class=\"token operator\">=</span><span class=\"token string\">\"2\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>VisibleTodoList listId<span class=\"token operator\">=</span><span class=\"token string\">\"3\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>在这里，<em>VisibleTodoList</em> 组件的多次调用，传入的不同 <em>listId</em> 参数，会共享一个 <em>getVisibleTodos</em> 实例，导致不会按照预期缓存结果。</p>\n<p>要想解决这个问题，需要给每一个组件单独生成一个 selector 实例：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// *1. 动态生成 selector</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">makeGetVisibleTodos</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createSelector</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span> getVisibilityFilter<span class=\"token punctuation\">,</span> getTodos <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">visibilityFilter<span class=\"token punctuation\">,</span> todos</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// *2. 组装</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">makeMapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> getVisibleTodos <span class=\"token operator\">=</span> <span class=\"token function\">makeGetVisibleTodos</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      todos<span class=\"token operator\">:</span> <span class=\"token function\">getVisibleTodos</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> mapStateToProps\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// *3. 传入组件中</span>\n<span class=\"token keyword\">const</span> VisibleTodoList <span class=\"token operator\">=</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  makeMapStateToProps<span class=\"token punctuation\">,</span>\n  mapDispatchToProps\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>TodoList<span class=\"token punctuation\">)</span></code></pre></div>\n<p>更多关于这个问题的细节见 <a href=\"https://github.com/reduxjs/reselect#accessing-react-props-in-selectors\">reselect 文档</a>：</p>\n<p>以上就是整个的 reselect 结合 redux 源码的性能优化细节！</p>\n<h3 id=\"redux-ignore\" style=\"position:relative;\"><a href=\"#redux-ignore\" aria-label=\"redux ignore permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>redux-ignore</h3>\n<p>在讲解 <em>combineReducers</em> 时，浮现过一个问题，我们的复杂 state 会拆分成多个子 state，并且有对应的 reducer 函数，但有个问题，外部每次发起 action，其实所有的 reducer 函数都会走一遍，不管是不是跟其匹配，这就造成了性能的浪费。</p>\n<p>redux-ignore 是用来解决这个问题的一个库，其使用很简单，在 combineReducers 时，确定 action 的适用范围：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 只 reduce 符合正则的 action </span>\n  counter<span class=\"token operator\">:</span> <span class=\"token function\">filterActions</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">COUNTER$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 只 reduce 符合 [] 中的 action</span>\n  notACounter<span class=\"token operator\">:</span> <span class=\"token function\">filterActions</span><span class=\"token punctuation\">(</span>notACounter<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">STAY_COOL</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">KEEP_CHILLIN</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>其源码：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// *ignore 是忽略或者过滤模式</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createActionHandler</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ignore</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// redux-ignore higher order reducer</span>\n  <span class=\"token comment\">// *返回一个高阶函数</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleAction</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">reducer<span class=\"token punctuation\">,</span> actions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// *判断入参条件</span>\n    <span class=\"token keyword\">const</span> predicate <span class=\"token operator\">=</span> <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>actions<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">?</span> <span class=\"token function-variable function\">actions</span>\n        <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span>\n    <span class=\"token comment\">// *生成一个初始 state</span>\n    <span class=\"token keyword\">const</span> initialState <span class=\"token operator\">=</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// *入口：跟 reducer 一样</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// *如果 action 是相匹配的</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">predicate</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// * ignore 模式下直接返回 state，否则走 render 模式，更新</span>\n        <span class=\"token keyword\">return</span> ignore <span class=\"token operator\">?</span> state <span class=\"token operator\">:</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// *action 没有匹配</span>\n      <span class=\"token comment\">// *ignore 模式下：调用 reducer，否则返回 state</span>\n      <span class=\"token keyword\">return</span> ignore <span class=\"token operator\">?</span> <span class=\"token function\">reducer</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> state\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ignoreActions <span class=\"token operator\">=</span> <span class=\"token function\">createActionHandler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> filterActions <span class=\"token operator\">=</span> <span class=\"token function\">createActionHandler</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>原理很简单：</p>\n<ul>\n<li>当 action 不符合规则时，直接返回原 state，不走 reducer 流程</li>\n<li>当 action 符合规则时，走 reducer 流程</li>\n<li>ignore 只是用于控制 ignore 或者 filter 两种模式</li>\n</ul>\n<h2 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>本文最主要的内容是学习 Redux 的源码，理清了 Redux 的原理。以及学习了 Redux 周边的涉及性能优化的两个库： reselect.js 和 redux-ignore。</p>\n<ul>\n<li>\n<p>Redux 源码如何组合的</p>\n<ul>\n<li>getState 实现</li>\n<li>subscribe 实现</li>\n<li>dispatch 实现</li>\n<li>combineReducers 模块和 bindActionCreators 模块</li>\n</ul>\n</li>\n<li>\n<p>中间件原理</p>\n<ul>\n<li>常规中间件的原理：中间件是如何一步步成型的</li>\n<li>异步中间件的原理： redux-thunk 的设计</li>\n<li>applyMiddleware 模块组合中间件</li>\n<li>洋葱圈模型</li>\n</ul>\n</li>\n<li>\n<p>性能优化</p>\n<ul>\n<li>reselect.js：缓存重复调用 selector 函数的结果</li>\n<li>redux-ignore：过滤非必要 action</li>\n</ul>\n</li>\n</ul>\n<p>本来想深入 React-Redux 原理，但看了下其源码有点多，准备后面再开文章学习。</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://juejin.im/post/6844904036013965325\">8k字 | Redux/react-redux/redux中间件设计实现剖析</a></li>\n<li><a href=\"https://redux.js.org/tutorials/fundamentals/part-4-store#middleware\">Redux Fundamentals, Part 4: Store | Redux</a></li>\n<li><a href=\"https://zapier.com/engineering/how-to-build-redux/\">Build Yourself a Redux - The Zapier Engineering Blog | Zapier</a></li>\n<li><a href=\"https://github.com/reduxjs/redux-thunk\">GitHub - reduxjs/redux-thunk: Thunk middleware for Redux</a></li>\n<li><a href=\"https://github.com/omnidan/redux-ignore\">GitHub - omnidan/redux-ignore: higher-order reducer to ignore redux actions</a></li>\n</ul>","frontmatter":{"title":"Redux 体系详解","category":"React","tags":"React","date":"2021-04-12","uninqueid":"1453f64cf61456dfab0a88ae88b4a596"}}},"pageContext":{"uninqueid":"1453f64cf61456dfab0a88ae88b4a596"}},"staticQueryHashes":["3649515864"]}