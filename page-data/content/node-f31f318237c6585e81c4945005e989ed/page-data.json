{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/content/node-f31f318237c6585e81c4945005e989ed","result":{"data":{"site":{"siteMetadata":{"author":"橡树上","title":"十二棵橡树"}},"markdownRemark":{"id":"7f6430db-7a93-5e01-8734-5cad75a5f4d5","html":"<blockquote>\n<p>之前的一篇<a href=\"https://betamee.github.io/content/webfrontend-a9df45bfb68f52299939acc4cf266ebf\">文章</a>)写了浏览器中的 JavaScript 的运行机制，谈到浏览器和 Node 关于事件循环的实现有着很大不同。本文将理清 Node 的事件循环机制，以作对比。\n另外一个重大变更需要知道的，自从 Node V11 后，Node 中的事件循环已经和浏览器中表现一致了！具体见文。</p>\n</blockquote>\n<h2 id=\"目录\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%BD%95\" aria-label=\"目录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目录</h2>\n<!-- toc -->\n<ul>\n<li><a href=\"#node-%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84\">Node 的设计架构</a></li>\n<li><a href=\"#%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E\">阻塞和非阻塞</a></li>\n<li><a href=\"#%E5%85%B3%E4%BA%8E-libuv\">关于 libuv</a></li>\n<li><a href=\"#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%87%A0%E4%B8%AA%E9%98%B6%E6%AE%B5\">事件循环的几个阶段</a></li>\n<li><a href=\"#%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%8F%E4%BB%BB%E5%8A%A1\">微任务和宏任务</a></li>\n<li><a href=\"#nexttick-%E7%9A%84%E9%97%AE%E9%A2%98\">nextTick 的问题</a></li>\n<li><a href=\"#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%9C%A8nodev11%E7%89%88%E6%9C%AC%E5%90%8E%E7%9A%84%E5%8F%98%E6%9B%B4\">定时器和微任务在NodeV11版本后的变更</a></li>\n<li><a href=\"#async-%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6\">async 代码运行机制</a></li>\n<li><a href=\"#%E4%BB%A3%E7%A0%81%E7%BB%83%E4%B9%A0\">代码练习</a></li>\n<li><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n<!-- tocstop -->\n<h2 id=\"node-的设计架构\" style=\"position:relative;\"><a href=\"#node-%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84\" aria-label=\"node 的设计架构 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node 的设计架构</h2>\n<p>从官网的<a href=\"https://nodejs.org/en/docs/meta/topics/dependencies/\">介绍</a>中得知，Node 本身依赖于好几个类库构建而成的，底层都是 C/C++ 编写的，用于调用系统层级的 API和处理异步、网络等工作。</p>\n<ul>\n<li>V8: JavaScript 引擎，由谷歌公司维护</li>\n<li>libuv：它是一个 C 编写的高性能、事件驱动、非阻塞型 I/O 类库，并且提供了跨平台的API</li>\n<li>llhttp：C 编写的 HTTP 解析类库</li>\n<li>c-ares：C 编写的用于处理某些异步的 DNS 请求</li>\n<li>OpenSSL：安全相关</li>\n<li>zlib：压缩</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.400000000000006%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC3ElEQVQoz02PWU8TYRSGJ+69dgVaRARUSJRAEEyMdLS0lEoJnTjtdBlIxM6wxxBA9EKj4Ud4pUZSKLh7ASYugWBQEzABCRgigYitYKuggMg3c47fFFEvnrxPznnPNxkGAPYoKpgURWXXUVVgEYGlc5buqSOrwppr/N/9C32D7nYzYxMRsfHac/Q3dkPVhSdYqdHcg1JTN/UelJvWXG7+l5XrPYp2Q2+xufUFzn5ZdDOvhz6JJmcHZppuKDnWW5BtuQlGRwBs3i4w8R2xLHR3gtkVjKVFCALLBSDbfBO0vga9VekOp2cWBGZwOOzjKu6ikWtTTM4AnOIDYBbaocgbBIu7A6yejpgX/kmrJ0gfb6cfC4DW18int7x0Dz+GvgvMm7FB8XiNBdO8WUpGeS5klOVietlRPCTm4AFfNk3qvhw8SEnzZuMBSjrtZNCO1tVuUj1Zan5dEU6FpwWmb7hP1At63GDZpGyz6UBXpMPNhVtwJ7cLU8T9mOhOxDhnHE0DppalYjz1rdYtqLPpUOvShI3mjWqSNwknZiYEZmB0QDxccQQTSrcrBl4PCU4D7hUMmOxOwmRvChpcSWhw7qWzfbjPkxLL+DP6vyTwibCjdLea6c/CD6FJgZmfHBdfXZUxePG88uxSNQzdb4A7QRc87OLh6aMG4AQerMVWkKr9wLk4KOVLqUtgK7EB7+HBT+fmIrNSXlGOoVBIYBbGh31vq+zYKfl/9Vfw5H1QJLevG8mDtuOk904ZOckWkLzcXHLadpqYTpqI8UQ+sRfbCWtkibnATDgHR47lHVulM5yemnYxPybHz4601uPolXM4crkGRx+34Lv+WhzrrcWXPS3o8fjQXmLHurpa6h50uVzU69DhcKDX58X6+nosthejJEkYDodFRl1dTfs1H61dmvssrXyNyKvL3+TlxZD8cykkr1CfnZ2VaVGORqMx14hEIrHZutNflebm5moIISm/AXTgBP6ckUGOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node 架构图一\"\n        title=\"Node 架构图一\"\n        src=\"/static/7a0fdcfbfd1be078f8fcac56f8417d0d/00d43/e52da68e.png\"\n        srcset=\"/static/7a0fdcfbfd1be078f8fcac56f8417d0d/63868/e52da68e.png 250w,\n/static/7a0fdcfbfd1be078f8fcac56f8417d0d/0b533/e52da68e.png 500w,\n/static/7a0fdcfbfd1be078f8fcac56f8417d0d/00d43/e52da68e.png 1000w,\n/static/7a0fdcfbfd1be078f8fcac56f8417d0d/2cefc/e52da68e.png 1400w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 634px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEdklEQVQ4y4WU228bRRTG/dch3vqIEHlApVSFNkJRiuAFAaoQVKigPCRKRBJaShJFciIrl9Z1LnUutuP7/bLetb2O1+vL7vqe+Bb748w6LqFQMdLnszve+c03c86Mod1uo9vtot/vYzgcgjVJE7ETWoc5uqnLEjPBEjW9iebIqJ99k1UFDAdDtDttMJaB/QwGA1xdXUFRFVw2O3AKr3H72Xu4t3ILD40TeLQ7iUc7k/h26zM9Tm9M4O7qLXz8/H3YUhbdxL+AvV4PoiiiVCgjIYcwf/ITlu2/YtH2BM/OZvCna1bXU8cMluxP6L9fsEDfcKWwDux0O38DmbubLaVGMW//Hr+7HmPp7Ees+WaxGVoiLdPzHBadj7Hs+hkLjh/AlUPvBg4Ho9jJ+6HuTEHdnkLNt4isaR3R+7d1yZsrWLCWMf00g4d/ZOAWGqMxne5/AQd67OdcuNj8lHQPXc8cymurECfvQ5z6ArWV55g77ODBb2U8WFTg4C7/H9gjYMP0OZrksE3A4toK0l9OI/31V1AJuHx6ie/WiviG5BIu3g0k4jXQjcbGHTSMn4yA62vgP/oAwsSHqBB8Zu8Cd2YLuDtfgp1rXWf5xh6yDI9L54pqatht4koTdA1aBXRZOSU5UhJ9RYFcG0Io9CAU+2i0R7Xbp7EdghpYUTPYTVWrVWiVKirVuv5crVVQbzVQa9b151aVJmiouKiVUdPK0JQStHIJzWYDBnZCarUaNE2Dqqpoti4gxv1QOCfUpBv5iB2luBP5MIsuXXLMiVzYgTLnhcr7UEn5UaA+KSvCwGx6vV4EAgH4fF7wQgrVfBqoMGVwZt6Ea88Ev3UXthdGOC0mBI/NcFC/Z38LcsQFNAvoFwUU8tJoDxn08vJSV7fXRzxAjuJnkDk3CuRSSZGLbAiqGIRGURPDuuSkBxI5LpBTkRznxg7HSWGx1+0hEg8gJUeRLXGQ6PAHCP7a/hKnrn1YHWZY7WbYPAdI56M4L3O6kjRZLpeFgWWo0WggSRkslYp6xrJSijKZBi9FdHAg7sDO3gZOCPjy0ISD0xfYthiRlmM0aQI5JYlCNY28nIOBXVkMmMlkUK/XdSCfjiFdiMIdOoYzYEU46UIw4UQs5UWEdyNICXMFjxHiRv3xtB9CLgxJOofh7YuBtRgXouVZ4KcM+yM2BGnJDOKN2uAOnyAieHRQhPfQhEfwx+w0qRvnOXEEZC7ZHo4v2KwkwEMDt18ZcXi8Cz4TREaO074dwri9Cp7cCDnaDimK3b1N2l8z8nQI9CW/OccEGwMFMYFaV8aZ3wqJEiMrAgTaT7GYwKn7AOVGFrG0D5LCw+Gz6svPq/w/l/w2MEuZ01o5aDQ4m4+DP4+gWMugVBcpivq+sXe5koLSPNfh+Tw5HFzfMGMoa4GwGyfuV7C5LTiy7+LUaUE84yPHh9g/3UE05dEdJkQ/LEdbcFB/Wo4gJ1HZsNpjx28sNoGYzSCRjJCieoxzYarNIJKpOCmGBB9FOBYAJ8SQFEbvLCpKGX8BFKcbipTlAyoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node 架构图二\"\n        title=\"Node 架构图二\"\n        src=\"/static/299456fa2f159641a724836fc4e1992d/374ac/ef31e0c2.png\"\n        srcset=\"/static/299456fa2f159641a724836fc4e1992d/63868/ef31e0c2.png 250w,\n/static/299456fa2f159641a724836fc4e1992d/0b533/ef31e0c2.png 500w,\n/static/299456fa2f159641a724836fc4e1992d/374ac/ef31e0c2.png 634w\"\n        sizes=\"(max-width: 634px) 100vw, 634px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>由这张整体的架构图可以看到，Node 最重要的是 V8 和 libuv 这两部分，V8 不用说，是解析运行 JavaScript 的引擎，没有 V8 就没有 Node 的今天，而 libuv 是 Node 另一个重要的基石，提供事件循环和线程池，负责所有 I/O 任务的分发与执行，对开发者来说不可见，只需要调用封装好的 Node API 就可以了。</p>\n<p>下面是另一张类似的原理图，可见要想深入理解 Node，必须要了解 libuv 的设计（深入理解需要学习 C++、操作系统）。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVQoz12S3XKbMBBGeZnE9TiEgEEgyYhfAf6L3bHdNJedTt//EU4XMtOLXjASO9LZw34EWZbx/xPHMWXpGIaRw+HI6XSW/cA0TZxl73tPkiT/ziuVY60lz3OCpuvw3tPJ2vU9+/2Bx/3B/XbnernQNI1cUmit0UVBYSzT8byAC3lXSi3rDC7LksBXpXTsGcaJvm3xM3iY8NOexo80bUcr9dl6HUa47I3BZGyVwAv9BRND74flXDDsclqxaOeLAj/XhjaN0C8rDjphkmamrBiLmN/FE+/pmvftinv6zK2z/Do2PFzKKAKzWJBLlzAMeYsiXsJXhr5jbxVdnnB1OaMYZ3mBUSltsiGVz39Vms/8GxcBrzYheZosI6vrhmCezaw9F1KZgxfgbFzVNXXT0UsAmbbcTMRn9kRU7FDW0cQbvu+2CzxJU4wxOFcRzOl8JaXYSverr/lhZU5icxPDSQJTAjzrmD/6mSEN6bchP/M1H77kY6zpdYaxuyXABai1WTrMtq6qMbuSQmpWUqvFtHSOvrS0VnN3apnZ5CyXvubUVRyHjlFCnf+Wv50SEs76ghWhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node 架构图三\"\n        title=\"Node 架构图三\"\n        src=\"/static/f82cb4d8620c68b3fda9eda093bff919/5a190/9adade0d.png\"\n        srcset=\"/static/f82cb4d8620c68b3fda9eda093bff919/63868/9adade0d.png 250w,\n/static/f82cb4d8620c68b3fda9eda093bff919/0b533/9adade0d.png 500w,\n/static/f82cb4d8620c68b3fda9eda093bff919/5a190/9adade0d.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"阻塞和非阻塞\" style=\"position:relative;\"><a href=\"#%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E\" aria-label=\"阻塞和非阻塞 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>阻塞和非阻塞</h2>\n<p>在 I/O 操作中，代码有阻塞和非阻塞之分，也就是同步和异步代码，Node 同样提供了两套 API:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 同步阻塞</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 异步非阻塞</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>由于在 Node 中 JavaScript 的执行是单线程的，所以一旦发生长时间阻塞，会严重影响后面代码的运行，不像其他语言可以新开一个线程处理。如果选择了非阻塞的方式，就可以释放当前的 JS 引擎的工作，用于处理后面的请求，比如一个服务器请求要花 50ms，其中 45ms 花在了数据库 I/O 上，选择了非阻塞代码，可以将这 45ms 处理其他请求。这极大了提高了<strong>并发性能</strong>。</p>\n<p>另外一个要注意的是，千万不要混用阻塞和非阻塞代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ！此代码有严重问题，会造成 BUG</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">unlinkSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 正确做法！</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">readFileErr<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readFileErr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> readFileErr<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/file.md'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">unlinkErr</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>unlinkErr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> unlinkErr<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"关于-libuv\" style=\"position:relative;\"><a href=\"#%E5%85%B3%E4%BA%8E-libuv\" aria-label=\"关于 libuv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>关于 libuv</h2>\n<p>libuv 是一个跨平台的类库，提供了<strong>事件循环（event-loop）机制</strong>和<strong>异步 I/O 机制</strong>，下图是其架构图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.400000000000006%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPElEQVQoz62R20uTYRzH3z+kq+jCuoggKS+6ig4SBd0EURSRNxEURZARHaRSOljZgdB6Z+reZWs6zzgtlrqVO3iaSqDOuYNzexftna6JE+XT8755500XPfDl+/3+fr/ny+/hkQLjE8QXFsjn86ysrPwjNs/q93O5HJKaSpFbXuZ/nGWRI+mp2WyW7FKW1fyqgfwGNmmxmc5ra2ubsL6+/nfDcCxEdD7C/EKMxd8Z0plfZJbSQmukNaGzmuG1xTRLOV1raFqGeDxOOp0mGo0aHIvFRF1DkitasL3rocvaR3WZDUdzv/AO3t5v4kuHm7rKNiwvu4z+q5tW2pWvqKkEPo+HcCiE2+UiMjeHa6AfNZlEqjgvU3PLSuOzDsrPyVhfdyLftfGwpJY2Uy9VlxWqrjWgPP9E2ekXKJU2Ej8T+AMTRBJJhiYmDfYFxkmoKSSTX6FhyIrsNWMeFsEjzcJ/pNZvod7/EZPPzEBwkI6hGUx9Y3zwTDE3OUnAIvOjycKoYhKsMNZYhxoKIl3ovM6V7tvccT6mtPeBgRufy4V/YtQvin7DSDtHnjopKLVScM9Bd3UNrbu3YD9YSOuhQuz7d9FUtI0ZRzvSYfNJDtSfoNpXz1n7JXRf0nqVN973HLOc4ajlFI/6ajhe5WRHaSM7yx30yCZairbSXLwXe/Ee7CLUtm870z2dSO6gB5d40kwyhD88iu6HI2NMJ2f5FvQaXu+NziZwjof4PhVHFT8aHRwg4nER3uCI100mpfIH6VqbW24hycwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Libuv 架构图\"\n        title=\"Libuv 架构图\"\n        src=\"/static/2697f25bdbeef57a5a29588793082df0/00d43/82fc60ff.png\"\n        srcset=\"/static/2697f25bdbeef57a5a29588793082df0/63868/82fc60ff.png 250w,\n/static/2697f25bdbeef57a5a29588793082df0/0b533/82fc60ff.png 500w,\n/static/2697f25bdbeef57a5a29588793082df0/00d43/82fc60ff.png 1000w,\n/static/2697f25bdbeef57a5a29588793082df0/b12f7/82fc60ff.png 1020w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>libuv 作为底层的基石，将上层传递下来的 I/O 请求分配线程池，比如定时器请求、读取文件请求、网络请求等，待其完成后，再由<strong>事件循环机制</strong>分配各个请求的注册回调事件到任务队列（或者说消息队列）中，通知上层的 JS 引擎，空闲时捞起队列中的回调函数。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 561px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVQ4y4VU25KiMBTk/z9q9gN2XixrBcXbeBlAFC+gAgF702fmsCxizanqSiBJp88tDl7Y4/EQ0G63m0D/t9fb+zg63YXuAVqapoLu/z4Bzit1tKqqEMcxFosFlssl1us1zuczrtcrNpsNfN/HeDxGFEWo61rOOHQlz3PB/X5HWZY9CjOBGg9vt1shHI1GMudZwrlcLqKEREVRIMuyJ8VZekZ6OTdkQRDAGCMEDMXxeBRQvcOfbaNSkn+NBWorcrHdCyrrVfC5lYtpJEiSREbidDp9uawu8vbpdIr9fm9vTPAZxRgHd3hhhXFU4886w8cmaPbTG4IcjCvHJ4W8RW1zNHAt2XRXw7fwLOkqqZoEMFzcz5EQl5k9xoQZJLQ8jKkwjw2Gqyvefvv49T7D8CPDNCplTWJr1YVhCM/z4LquVIRDqeouk8Pv7+LBal9gFBjrdilw7XwZF3Z/3dQnk0GVhCjUGGpc/hHaDikM/DCHZ4m80GBi51lumnUSPrncjWG3xUqrOklLHCyKb1fbHURCjkrq8IPusq5YKlqHP7WYJkVLp6lDEtJNLnKBJcN5l6Du6XetxdlsJkJYnw4TQXWqkkZiZkwLuM94jqooQMtIepldwTjyVu1j7RhuJjEVUwG94Xg4HOR/u02b14aL7fbpJolK+LJMJhPM53Psdrv/Ln56D0k2HA4xGAyEuJ3lvqS8ItK5w7RTJUHXVOGrl/kVkdpf/cHDn76z7P8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"事件循环\"\n        title=\"事件循环\"\n        src=\"/static/5d22126489874b1af3dab43daa5a7128/410f3/d65a385f.png\"\n        srcset=\"/static/5d22126489874b1af3dab43daa5a7128/63868/d65a385f.png 250w,\n/static/5d22126489874b1af3dab43daa5a7128/0b533/d65a385f.png 500w,\n/static/5d22126489874b1af3dab43daa5a7128/410f3/d65a385f.png 561w\"\n        sizes=\"(max-width: 561px) 100vw, 561px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>上图中描绘了事件循环机制的具体过程：</p>\n<ol>\n<li>事件调度器（Event demultiplexer ）接受 <strong>I/O 请求</strong>（如文件、网络），将其发给各个具体的线程或者专门的模块进行处理（底层实现比较复杂，具体见 NodeJS Event Loop Series）</li>\n<li>等 I/O 处理完了，事件调度器将<strong>注册的回调事件</strong>放在<strong>任务队列</strong>（或者也可以叫 Event Queue）中</li>\n<li>循环往复</li>\n</ol>\n<p>事件循环机制将如上所示不停地保持运行状态，管理任务队列，调度各类事件，协调上下层之间的工作。而对于前端开发者来说，只需要考虑 JS 代码运行的模型，实现<strong>异步非阻塞</strong>的具体过程将交由 libuv 负责。</p>\n<h2 id=\"事件循环的几个阶段\" style=\"position:relative;\"><a href=\"#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%87%A0%E4%B8%AA%E9%98%B6%E6%AE%B5\" aria-label=\"事件循环的几个阶段 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>事件循环的几个阶段</h2>\n<p>具体到事件循环（event loop）中，也是分为好几个工作阶段：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 681px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.19999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC2klEQVQ4y4VUiW7bMAzN/3/Rhg0Y1qJDsHZo2iTN2RyO49vyJcuOj7yRcpOmaNcJIExB1uN7JMVelmVomgZVVaGu67Pxno3XzrRg2a72+f8oipDnORzbwmBwj6fxCGma6LNeWZb4dLU56lJow1GhKAq6nBKgwtZJMVs7mBsB/EhCURANqKM5jjaOcjgc6JKE58WQ/hCZc414f4Ume4IQIXzPQygiDHcKX24muB7aMMOSAIkhR/xolWVNqWjJq5FLgSTyyG/ODKNEYudJ2KKEGSjYQYY0k+jxIVsYhojjmBgIAiuIaUERKS/eHdz1FezVT6TuHZLYgx8IPO0k+mMb3/tTXN2vcbeIsA8VeiyXZUspcZJf1xXtC9orlNJCJraI/RX5NrI0ouACWy/Hyi0wWnmYmzFWXglXyM8lt+0Rx8qHZz7C2t6Tev8suVA5KZBaTaGU9vP8E8CiqHQOm3yNyLpFaPbJX0HR5SRJtBJW9Wq5th5vTj3H1WXZ3JddURqCrpBnIRXF1UV5D5hfGDHkQrCZpgnDMOD7vr6QJFJfSrwBrOU3mLOvyIKBlngJyN9L+28OmZWUEeLI5y5/x/ASTJ4A+YB/4qZmtlV1IJ8STWetekZs9yHMXxSFc5j/M4e6KJw3zh/n7gTets1L2xyoyiFUskEaPhPZ6KXKmWbKlS4LpY3BdFGYEYMwu+4r6ZLqAClYXXgI7Amc3VD73DKCHoEvEsz3GcbrEE9GAjeiNlLyFdC2bViWpS+wLJasWcdziH0fvnGDMpm9ARxuU9xOXfxZCjgiJ8YEyNQ/WkoRu7rB8UiDIvYhArtrIcodjyqeLltX0jvOYdCrsfy0a5vj8Xiec/rR06w7HEoCa4khzchsisi8RrD9gVZONXtmuPYUbsYubmcBfs9CjA2aUlSL3mg0wnK5xGKxeGPLZfedz4ZYTB86I38ymeh+nSw2eJhu8TjrbDTbYLPZ4C8f91wfT4wyEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"事件循环各个阶段\"\n        title=\"事件循环各个阶段\"\n        src=\"/static/402a12f11f3c321372c4dca59495cd38/8ce52/2b2830c2.png\"\n        srcset=\"/static/402a12f11f3c321372c4dca59495cd38/63868/2b2830c2.png 250w,\n/static/402a12f11f3c321372c4dca59495cd38/0b533/2b2830c2.png 500w,\n/static/402a12f11f3c321372c4dca59495cd38/8ce52/2b2830c2.png 681w\"\n        sizes=\"(max-width: 681px) 100vw, 681px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<ul>\n<li>定时器（timers）阶段：这个阶段执行 <code>setTimeout</code> 和 <code>setInterval</code> 的 callback</li>\n<li>待定回调（pending I/O callbacks）阶段：这个阶段执行一些系统操作的回调，比如 TCP 错误。名字会让人误解为执行 I/O 回调处理程序, 实际上 I/O 回调会由 poll 阶段处理。</li>\n<li>idle, prepare 阶段：仅 node 内部使用</li>\n<li>轮询（poll）阶段：获取新的 I/O 事件, 例如操作读取文件等等，适当的条件下 node 将阻塞在这里</li>\n<li>检查（check）阶段：执行 <code>setImmediate</code> 设定的 callback</li>\n<li>关闭的回调函数（close callbacks）阶段：一些关闭的回调函数，如：<code>socket.on('close', ...)</code></li>\n</ul>\n<p>最重要的是 timers、poll、check 阶段：</p>\n<ol>\n<li>定时器（timers）阶段：</li>\n</ol>\n<p>指定一个下限时间，而不是精确时间，在到达下限时间后，timers 会尽可能执行回调，但系统调度或者其它回调的执行可能会延迟它们。</p>\n<p>从技术上来说，poll 阶段会影响 timers 阶段的执行，所以 <code>setTimeout(callback, time)</code> 中， <code>time</code> 参数只是一个下限时间，是指到了这个时间后将 callback 置于 timers 阶段的队列中，至于真正的执行需要看事件循环有没有轮到这一阶段。</p>\n<ol start=\"2\">\n<li>轮询（poll）阶段</li>\n</ol>\n<p> 轮询（poll）阶段是事件循环最重要的部分。它有两个重要功能：</p>\n<ul>\n<li>处理 poll 队列的事件</li>\n<li>当有已超时的 timer，执行它的回调函数</li>\n</ul>\n<p>事件循环将同步执行 poll 队列里的回调，直到队列为空或执行的回调达到系统上限。如果没有其他阶段的事要处理，事件循环将会一直阻塞在这个阶段，等待新的 I/O 事件加入 poll 队列中。</p>\n<p>如果其他阶段出现了事件，则有以下情况：</p>\n<ul>\n<li>如果 check 队列已经被 <code>setImmediate</code> 设定了回调, 事件循环将结束 poll 阶段往下进入 check 阶段来执行 check 队列（里面的回调 callback）。</li>\n<li>如果 timers 队列有到时的 <code>setTimeout</code> 或者 <code>setInterval</code> 回调，则事件循环将往上绕回 timers 阶段，并执行 timer 队列</li>\n<li>检查（check）阶段</li>\n</ul>\n<p>这个阶段允许在 poll 阶段结束后立即执行回调。如果 poll 阶段空闲，并且有被 <code>setImmediate</code> 设定的回调，事件循环会转到 check 阶段而不是继续等待。</p>\n<p><code>setImmediate</code> 可以看作一个特殊的定时器，libuv 专门为它设置了一个独立阶段。</p>\n<p>通常上来讲，随着代码执行，事件循环终将进入 poll 阶段，在这个阶段等待 incoming connection, request 等等。但是，只要有被 <code>setImmediate</code> 设定了回调，一旦 poll 阶段空闲，那么程序将结束 poll 阶段并进入 check 阶段，而不是继续等待 poll 事件。</p>\n<p>这里可以用伪代码说明情况：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 事件循环本身相当于一个死循环，当代码开始执行的时候，事件循环就已经启动了</span>\n<span class=\"token comment\">// 然后顺序调用不同阶段的方法</span>\n<span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// timer阶段</span>\n\t<span class=\"token function\">timer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// I/O callbacks阶段</span>\n\t<span class=\"token constant\">IO</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// idle阶段</span>\n\t<span class=\"token constant\">IDLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// poll阶段，大部分时候，事件循环将会停留在此阶段，等待 I/O 事件</span>\n\t<span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// check阶段</span>\n\t<span class=\"token function\">check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// close阶段</span>\n\t<span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>另外一个要理解的是，事件循环就像这段伪代码指明的，是一轮又一轮循环往复，所以事件回调函数<strong>进入的时机</strong>也很重要，以下面的代码举例：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 案例一</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setImmediate'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出结果：</span>\n<span class=\"token comment\">// 不确定，setTimeout 和 setImmediate 无法确定进入时机</span>\n\n\n<span class=\"token comment\">// 案例二：</span>\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'file.path'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setImmediate'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出结果：setImmediate setTimeout</span>\n\n<span class=\"token comment\">// 案例三：</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setImmediate2'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout2'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 输出结果：setTimeout1 setImmediate2 setTimeout2</span></code></pre></div>\n<p>这几个案例中，我们通过分析得以一窥事件循环的机制：</p>\n<ul>\n<li>案例一：在由于系统运行性能的不同，所以 <code>setTimeout</code> 进入 timers 队列时机不确定，可能比 <code>setImmediate</code> 早，也可能晚，这就导致了循环下来，输出的不确定</li>\n<li>案例二：进入事件循环的时候 <code>fs.readFile</code> 是在 I/O poll 阶段，所以事件循环的下一个阶段必然是 check 阶段，然后再绕回开头的 timers 阶段。所以一定是 <code>setImmediate</code> 比 <code>setTimeout</code> 早</li>\n<li>案例三：跟案例二相似，进入事件循环是在 timers 阶段，当此队列的回调执行完成后，又新增了 <code>setImmediate</code> 和 <code>setTimeout</code>，然后事件循环离开 timers 阶段，往下先进入 check 阶段，再回回过头来进入 timers 阶段。输出结果必然也是确定的。</li>\n</ul>\n<h2 id=\"微任务和宏任务\" style=\"position:relative;\"><a href=\"#%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%8F%E4%BB%BB%E5%8A%A1\" aria-label=\"微任务和宏任务 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>微任务和宏任务</h2>\n<p>在 Node 中，还有另一个非常重要的概念是微任务和宏任务，微任务是指不在事件循环阶段中的任务，Node 中只有 process.nextTick 和 Promise callbacks 两个微任务，它们都有各自的队列，<strong>不属于事件循环的一部分。</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAADVElEQVQoz1WSe0gUURTGz1qaQk+jBxaJUvYwxKAiiYJelFZYUREVBRH0UtKCqEAyekAYSEmWitim25blKuu2Zrm6r5nZmZ1Z92H5aFdzs3ZNc3dSM/CP27kWQgMf517m3N85594PAL/iMn2qvsmbaXeNpqE2C86RnXzr8B5PJ0lpMn9p09S7el7Xu7qNpt52v3NoH+scTRddo5sIIRHVtRJgVKBg4qOLoifalAaD7zwnhQtZMaRFXWHsQ7sF5/BqExt8X1Rcwzwpf2PhuKClh+/LMIrh9Zw4dAjzrmNeguAaAWxAMU6h+w+eikJu1LmsG4s5SRZU1dxKWoSqTm0AQ2UdaB6Ugr5EBWkblsO43T/fJf4AqxQGbGABhVr4wRgLP6DAvQKyc29Drc4DwRCZi1WuYAIwXCBSwnEas45FGk5ujw/eOJfQdX734tY7eeu+6Znk0arnINoCMexf6B6bQ96IERgxDNDOB2a2899uOozeQsnoK+ngA7mD1q7kEY+c1F3xLNOnqukzFCu/W8ueB3tf6fvFSyfWdeTnAhYE1iEnsWI4m7GHznKOn+lYIA7wnhZhV+RpVTOpfGEmWKlfeO+eJt7JA+bC4ZXepypielRObKWVpEdVQ6SrZ3ecxjtifhIQXSPKd83dpKyigRhMfiJ5xk7QliNRa1j70DZODB3A9Sqb+s0UKe8isBePJ3qV6jZdQdFHXcHDD15VzceOR0VHfnWOJ4Za3Amf7YFdbrPvqkUrXG4z+3K6pYGl0MJ8p1DgHHI8xjN0LQgDUUSjhWCzeyGOnXoJYJpmBczQboudpTyTEUENYpbkKMEhg611eKt/gCwxWvrA78c/FIAjR2jqnTRexv0yetlO+yAQpj2GfBqb3aRuhIrCcnj7sgl41g+MJE+cQy/OxAd53Gz9+hntlYNe/gukz/0vzkddo6NbJDmliw+sdgr9L+sbO1/X6dyvWqxfq0X3r2T03lr6umiVPGxiAwIZIxvIkTy/J4GTUEyYgsAt6LOjLhvekSPkVqrNgXv3lV/wkB8PpSFwL3a2927Bs3k4fQwqDjVHoVBMh/x88h+U+nDCXxhNjmFo5fsj0eRTqcJjZGpWzi1adCJf964Ttm7PjJ4TOy86Li4+GqGKP71yUnVZUOr1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"事件循环和微任务队列\"\n        title=\"事件循环和微任务队列\"\n        src=\"/static/506ef62c63659fd02fc8e1fabfc7e2c2/00d43/9f7f464b.png\"\n        srcset=\"/static/506ef62c63659fd02fc8e1fabfc7e2c2/63868/9f7f464b.png 250w,\n/static/506ef62c63659fd02fc8e1fabfc7e2c2/0b533/9f7f464b.png 500w,\n/static/506ef62c63659fd02fc8e1fabfc7e2c2/00d43/9f7f464b.png 1000w,\n/static/506ef62c63659fd02fc8e1fabfc7e2c2/aa440/9f7f464b.png 1500w,\n/static/506ef62c63659fd02fc8e1fabfc7e2c2/e8950/9f7f464b.png 2000w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>那么它们的运行时机是在什么时候呢？</p>\n<p>很简单，不管在什么地方调用，它们总是在各个阶段之间执行，上一阶段完成，进入下一阶段前，会清空 nextTick 和 promsie 队列！而且 nextTick 优先级要比 promsie 要高！</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 655px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEaklEQVQ4yyWS228UVRzHf7QDBNEY/QN8MvHBB31RE+ODMSREwVhJMBANhmhJMBHxAWOgBiw2QKlFQynSbXdpaWd2ty230sKyO9Tubi97mdn7pdvL0tJuL3ub3ZnZ2d3Ozs/T+PA733POwzefc75fwG8A8AKAwSHCpUmEyxNV+G1kDS7bVWh1Ilz3IFj863W48LC+6u2hMPmUwudWquLWEWUpXHpMYayPwmWWkhABIEEWshnyVX4x+PCRgVeNXdOS2cBrxts+HDVGsPFZNA8Y6AKRvQQYMQPGBqFgayE6DJhgALk/Aefugbxt+J4Nd+DZd14ye0t0F4+lLo+a6rQLGZ23tq7jUKQ5aWA+zL2dC1tu5tzM3WLMapJnbeaMq98sxllzNWExlf3GIXmW7V0R1L0QNdrqsenI7rEF/ORBTPvpwSw2WuO10yNx7eT9BDaOueZ/HHfO/FCc0UeFpxfVkrdPKvN35NyTC3KJH5BrvF5SJ1rKZR+9sVrC10BvmqUI6I47fu3eLa+GNyYl/Hs8gx1OEQkh9gawx7GCkMornxYreGhTUBrSxUqDoGgN6UK5YS1f/mKtoH75Ii0eDPCencAb/63D5uN7CNG+wYh2aiiKjSMB5fRwWD1pjuH3ozNzZ9x8sIkQpnNPmlH29iEhxMzYeSxx/Yg+PWr2Fqz6aVyv4utwxxSlkII6Qti7TdQ5KYkdE3nl5pQsdvOIfXyl512AXdkFrkmad/5VSHJXi0u+NnHO3lZc8rcJi96rQsLenlngWmafp/aA0zRVj2f3774X1Q4zIWzt91XOmzzFK7Sv3MxEsPm+e+XMhHP6q4KXdhTG21dln2lRCQwm8+zVpBwYSqpBenFr6tqyEhwOp2R8FYaNgXo8CtRAUGvu4TGk5zWHblpy63mcJGfOxBWuh/zcB4WIhcl7aLsUt1qVBGvLufpZkqxtK2GxVQPG8VKCHVnOVV/53/AwUHRQ+4MYRHu42pRuWuaI8Yzeh0GGE9sd7NibmZClI+81DQkRK12M2Zism2GEGMtIMQst8iazELUZkpvyXmDNnno89dauu1HtBB3CASao/WPiy71MUNXRYewmT26zT858V5zuDuUfn1dktyFf9t4WsqNNAqmQUPPqBHX8d5EEtbKyXRvaGKHwZRJKQOsioVRJsddv2IUs0Y1uDivk/toNP8LqZn5fRpA+38jkD6RzxQObOfHAZlYgWvyMzMHUZnZ/NBzaCb7t2lw+vXc0rn48FNFOkDn2KFA6ORzeOj4Yx68fTcV/drq4JsHRmcqO/IrS9C1UXDrMPDiDkqsba+5OVG3nsOwxVFMVUptDj7EOPyJ/6Nsa7SLFJrXB6xM57HAUkBBiv2/L1PcGUMW1+XNKKtpe2li4oqQXW+XVcKuSTraWNuavlFKRtuLa3MXFF2t74ByLQI8k4W4MP2RC2rfk744wAfUomSPGkHbsYQLf1z2JQm15CqrzLFSWvVBd4aCSsBLlobLkgsocC/JzDyynJfgPnTpdGJ4KPnEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"旧版本Node微任务处理时机\"\n        title=\"旧版本Node微任务处理时机\"\n        src=\"/static/03e82491fa591a27e1e83cb37841ff93/ae6b7/e241621d.png\"\n        srcset=\"/static/03e82491fa591a27e1e83cb37841ff93/63868/e241621d.png 250w,\n/static/03e82491fa591a27e1e83cb37841ff93/0b533/e241621d.png 500w,\n/static/03e82491fa591a27e1e83cb37841ff93/ae6b7/e241621d.png 655w\"\n        sizes=\"(max-width: 655px) 100vw, 655px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>下面是具体的一个案例，可以看到微任务 Promise，是在 timers 阶段之后才清空。说明微任务是在<strong>阶段之间</strong>才会处理，与浏览器只要有微任务就清空很不一样！</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Promise1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Promise2'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 输出</span>\n<span class=\"token comment\">// timeout1</span>\n<span class=\"token comment\">// timeout2</span>\n<span class=\"token comment\">// Promise1</span>\n<span class=\"token comment\">// Promise2</span></code></pre></div>\n<h2 id=\"nexttick-的问题\" style=\"position:relative;\"><a href=\"#nexttick-%E7%9A%84%E9%97%AE%E9%A2%98\" aria-label=\"nexttick 的问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nextTick 的问题</h2>\n<p><code>process.nextTick</code> 有一个很大的问题，它会发生“饿死” I/O 的潜在风险：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'file.path'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loopTick</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span>loopTick<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这段代码将会一直停留在 nextTick 阶段，无法进入到 <code>fs.readFile</code> 的回调中，这就是所谓的 <em>I/O starving</em>。</p>\n<p>要解决这个问题，使用 <code>setImmediate</code> 替代，因为 <code>setImmediate</code> 属于事件循环，就算不停地循环，也不会阻塞整个事件循环机制，因为事件循环会在一轮又一轮处理 check 阶段的回调，而不像 nextTick 那么霸道，必须立即清空！</p>\n<p>这特性在一些基础库中用得多。比如替代原生 Promise 的库 Q.js 和 Bluebird.js，相比于原生 Promise 的底层实现，Q 是基于 process.nextTick 来做流程控制，而 Bluebird 使用了 setImmediate。</p>\n<h2 id=\"定时器和微任务在nodev11版本后的变更\" style=\"position:relative;\"><a href=\"#%E5%AE%9A%E6%97%B6%E5%99%A8%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%9C%A8nodev11%E7%89%88%E6%9C%AC%E5%90%8E%E7%9A%84%E5%8F%98%E6%9B%B4\" aria-label=\"定时器和微任务在nodev11版本后的变更 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>定时器和微任务在NodeV11版本后的变更</h2>\n<p>随着 Node V11 的发布，nextTick 回调和 Promise 微任务将会在各个独立的 <code>setTimeout</code> and <code>setImmediate</code> 之间运行，即便当前的 timers 队列或者 check 队列不为空。这就跟浏览器的事件循环表现保持了一致！</p>\n<p>当然，这对于从 Node V11 以下升级到 V11 以上的代码来说，可能是个潜在的风险。</p>\n<h2 id=\"async-代码运行机制\" style=\"position:relative;\"><a href=\"#async-%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6\" aria-label=\"async 代码运行机制 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>async 代码运行机制</h2>\n<p>前面谈了微任务中的 Promise 队列，那么对于同样是异步的 async 函数代码应该如何解释呢？</p>\n<p>本段将简单说明以下 async 代码机制。</p>\n<p>async 函数本质上是 Promise 的语法糖。每次我们使用 await, 解释器都创建一个 Promise 对象，然后把剩下的 async 函数中的操作放到 then 回调函数中。async/await 的实现，离不开 Promise。从字面意思来理解，async 是“异步”的简写，而 await 是 async wait 的简写可以认为是等待异步方法执行完成。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resolved'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async done'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// => 等同于</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resolved'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// wait 会将 async2 变为一个 Promise</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 执行成功后进入 resolve 阶段</span>\n    <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// await 下面的代码运行时机是在上面的 Promise 运行之后</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async done'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"代码练习\" style=\"position:relative;\"><a href=\"#%E4%BB%A3%E7%A0%81%E7%BB%83%E4%B9%A0\" aria-label=\"代码练习 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>代码练习</h2>\n<p>最后整理一些代码练习，注意，这里区分新旧版本！</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 案例一</span>\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setImmediate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"嵌套setImmediate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nextTick\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 旧版本 setImmediate nextTick setImmediate2</span>\n<span class=\"token comment\">// 新版本 setImmediate nextTick setImmediate2</span>\n\n<span class=\"token comment\">// 案例二</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Promise1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Promise2'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 旧版本 timeout1 timeout2 Promise1 Promise2</span>\n<span class=\"token comment\">// 新版本 timeout1 Promise1 timeout2 Promise2</span>\n\n<span class=\"token comment\">// 案例三</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resolved'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'time resolved'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nextTick1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nextTick2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nextTick3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sync'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout3'</span><span class=\"token punctuation\">)</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nextTick4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resolved3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 旧版本：</span>\n<span class=\"token comment\">// timeout0</span>\n<span class=\"token comment\">// sync</span>\n<span class=\"token comment\">// setTimeout3</span>\n<span class=\"token comment\">// nextTick1</span>\n<span class=\"token comment\">// nextTick3</span>\n<span class=\"token comment\">// nextTick4</span>\n<span class=\"token comment\">// nextTick2</span>\n<span class=\"token comment\">// resolved</span>\n<span class=\"token comment\">// time resolved</span>\n<span class=\"token comment\">// resolved3</span>\n<span class=\"token comment\">// timeout2</span>\n\n<span class=\"token comment\">// 新版本：</span>\n<span class=\"token comment\">// timeout0</span>\n<span class=\"token comment\">// sync</span>\n<span class=\"token comment\">// nextTick1</span>\n<span class=\"token comment\">// nextTick3</span>\n<span class=\"token comment\">// nextTick2</span>\n<span class=\"token comment\">// resolved</span>\n<span class=\"token comment\">// time resolved</span>\n<span class=\"token comment\">// setTimeout3</span>\n<span class=\"token comment\">// nextTick4</span>\n<span class=\"token comment\">// resolved3</span>\n<span class=\"token comment\">// timeout2</span>\n\n<span class=\"token comment\">// 案例四：</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async1 start'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async1 end'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">async2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script start'</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">async1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise3'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script end'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 输出</span>\n<span class=\"token comment\">// script start</span>\n<span class=\"token comment\">// async1 start</span>\n<span class=\"token comment\">// async2</span>\n<span class=\"token comment\">// promise1</span>\n<span class=\"token comment\">// promise2</span>\n<span class=\"token comment\">// script end</span>\n<span class=\"token comment\">// async1 end</span>\n<span class=\"token comment\">// promise3</span>\n\n<span class=\"token comment\">// 案例五：</span>\nprocess<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nextTick'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise2'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise3'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 旧版本：promise1 promise2 nextTick promise3</span>\n<span class=\"token comment\">// 新版本：promise1 promise2 nextTick promise3</span></code></pre></div>\n<p>注意这里面的第三个案例有点奇怪，如果你能看出来的话，这点需要深入了解 async 的机制。</p>\n<h2 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>讲了这么多关于 Node 事件循环的机制，跟浏览器怎么个不同法，到最后发现，新版本 Node 已经跟浏览器特性保持一致了！随着新版本的逐渐普及，以后只要记住一种运行模型就可以了，当然，Node 的事件循环阶段过程也不能忘，有必要的话甚至可以了解一些 libuv 的机制。从一个坑挖向另一个坑～</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://nodejs.org/zh-cn/docs/meta/topics/dependencies/\">所有依赖项 | Node.js</a></li>\n<li><a href=\"https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/\">阻塞对比非阻塞一览 | Node.js</a></li>\n<li><a href=\"https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/\">Node.js 事件循环，定时器和 process.nextTick() | Node.js</a></li>\n<li><a href=\"https://nodejs.org/zh-cn/docs/guides/dont-block-the-event-loop/\">不要阻塞你的事件循环（或是工作线程池） | Node.js</a></li>\n<li><a href=\"https://blog.csdn.net/Fundebug/article/details/86487117\">浏览器与Node的事件循环(Event Loop)有何区别?<em>Java</em>Fundebug博客-CSDN博客</a></li>\n<li><a href=\"https://blog.csdn.net/WU5229485/article/details/103107550\">深入理解NodeJS事件循环机制<em>JavaScript</em>小青蛙的博客-CSDN博客</a></li>\n<li><a href=\"https://juejin.im/post/5c148ec8e51d4576e83fd836\">从event loop到async await来了解事件循环机制 - 掘金</a></li>\n<li>\n<p>NodeJS Event Loop Series（这个系列不错）</p>\n<ul>\n<li><a href=\"https://blog.insiderattack.net/event-loop-and-the-big-picture-nodejs-event-loop-part-1-1cb67a182810\">Event Loop and the Big Picture — NodeJS Event Loop Part 1</a></li>\n<li><a href=\"https://blog.insiderattack.net/timers-immediates-and-process-nexttick-nodejs-event-loop-part-2-2c53fd511bb3\">Timers, Immediates and Process.nextTick— NodeJS Event Loop Part 2</a></li>\n<li><a href=\"https://blog.insiderattack.net/promises-next-ticks-and-immediates-nodejs-event-loop-part-3-9226cbe7a6aa\">Promises, Next-Ticks, and Immediates— NodeJS Event Loop Part 3</a></li>\n<li><a href=\"https://blog.insiderattack.net/handling-io-nodejs-event-loop-part-4-418062f917d1\">Handling IO — NodeJS Event Loop Part 4 - Deepal’s Blog</a></li>\n<li><a href=\"https://blog.insiderattack.net/event-loop-best-practices-nodejs-event-loop-part-5-e29b2b50bfe2\">Event Loop Best Practices — NodeJS Event Loop Part 5</a></li>\n<li><a href=\"https://blog.insiderattack.net/new-changes-to-timers-and-microtasks-from-node-v11-0-0-and-above-68d112743eb3\">New Changes to the Timers and Microtasks in Node v11.0.0 ( and above)</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"Node 事件循环机制","category":"Node","tags":"Node_Deep 原理","date":"2020-04-25","uninqueid":"f31f318237c6585e81c4945005e989ed"}}},"pageContext":{"uninqueid":"f31f318237c6585e81c4945005e989ed"}},"staticQueryHashes":["3649515864"]}