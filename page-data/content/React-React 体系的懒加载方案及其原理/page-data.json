{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/content/React-React 体系的懒加载方案及其原理/","result":{"data":{"site":{"siteMetadata":{"author":"橡树上","title":"十二棵橡树"}},"markdownRemark":{"id":"8bc425ff-57a4-58fd-bf31-c4f6916d96e8","html":"<h2 id=\"目录\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%BD%95\" aria-label=\"目录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目录</h2>\n<!-- toc -->\n<ul>\n<li><a href=\"#%E9%97%AE%E9%A2%98%E7%9A%84%E4%BA%A7%E7%94%9F\">问题的产生</a></li>\n<li>\n<p><a href=\"#%E6%96%B9%E6%A1%88%E6%AF%94%E8%BE%83\">方案比较</a></p>\n<ul>\n<li><a href=\"#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5\">动态导入</a></li>\n<li><a href=\"#Reactlazy\">React.lazy</a></li>\n<li><a href=\"#loadablecomponent\">@loadable/component</a></li>\n<li><a href=\"#react-loadable\">react-loadable</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%8E%9F%E7%90%86\">原理</a></p>\n<ul>\n<li><a href=\"#loadablecomponent-1\">@loadable/component</a></li>\n</ul>\n</li>\n<li><a href=\"#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n<!-- tocstop -->\n<h2 id=\"问题的产生\" style=\"position:relative;\"><a href=\"#%E9%97%AE%E9%A2%98%E7%9A%84%E4%BA%A7%E7%94%9F\" aria-label=\"问题的产生 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题的产生</h2>\n<p>代码分割是目前非常流行的前端技术。随着前端工程的日益复杂，引入了很多第三方库，代码体积也变得越来越大，我们需要合理的管理我们的资源包。</p>\n<p>使用代码分割技术，将一个大的代码包拆分成多个小包，这个在页面前期只需要加载必须的资源，非必须的资源可以放在后期需要的时候再加载。比如有些模块用户可能都不会点击，只有等点击的时候才加载。这种懒加载可以显著提高页面早期的速度，提高性能体验。</p>\n<p>所以我们需要寻求好的懒加载方案。</p>\n<h2 id=\"方案比较\" style=\"position:relative;\"><a href=\"#%E6%96%B9%E6%A1%88%E6%AF%94%E8%BE%83\" aria-label=\"方案比较 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>方案比较</h2>\n<p>在 React 体系中，目前有这几种方案可以选择：</p>\n<ul>\n<li>import()</li>\n<li>React.lazy</li>\n<li>@loadable/component </li>\n<li>react-loadable</li>\n</ul>\n<h3 id=\"动态导入\" style=\"position:relative;\"><a href=\"#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5\" aria-label=\"动态导入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>动态导入</h3>\n<p>动态导入 import() 是 es 原生支持的的一个方案。</p>\n<p>import() 的优势是可以运行时加载模块，这样就能补齐 es import 命令的缺陷。因为相比于 CommonJS 的 require 可以动态加载脚本，import 命令是静态编译，在代码编译阶段就将模块关系确定了，所以这样的代码是毫无意义的：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 报错</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">===</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">import</span> MyModual <span class=\"token keyword\">from</span> <span class=\"token string\">'./myModual'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>有了 import()，就能动态加载脚本，在使用上非常灵活。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// a.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// b.js</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">===</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./a.js'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">module</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> Add <span class=\"token operator\">=</span> module<span class=\"token punctuation\">.</span>default\n      <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>更重要的是执行 import() 返回的是 Promise，是一个异步的模块，也可以用 async 函数对其管理：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> myModule <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./myModule.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      export1<span class=\"token punctuation\">,</span>\n      export2\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./myModule.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>\n      module1<span class=\"token punctuation\">,</span>\n      module2<span class=\"token punctuation\">,</span>\n      module3\n    <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./module1.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./module2.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./module3.js'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>不过缺点在于，import() 语法很新，老的浏览器可能不会兼容。通过 Webpack + Babel 会将 import() 转换为 Promise + domcument.createElement('script') 的方式（针对于 web 端）。</p>\n<h3 id=\"reactlazy\" style=\"position:relative;\"><a href=\"#reactlazy\" aria-label=\"reactlazy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>React.lazy</h3>\n<p>React.lazy 是 React 官方提供的一个代码分割方案。相比于import()，React.lazy 是针对于 React 组件的一个代码分割方案，需要配合 Suspense 使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Suspense <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> MyErrorBoundary <span class=\"token keyword\">from</span> <span class=\"token string\">'./MyErrorBoundary'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> OtherComponent <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./OtherComponent'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> AnotherComponent <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./AnotherComponent'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">MyComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MyErrorBoundary</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>section</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OtherComponent</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AnotherComponent</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>section</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">MyErrorBoundary</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>优势上 React.lazy 是原生组件，可以搭配 ErrorBoundary 特性，容错上也更好。</p>\n<p>缺点在于目前 React.lazy 和 Suspense 技术还不支持服务端渲染。所以如果要在服务端上使用懒加载，可以使用 @loadable/component 这个库。</p>\n<h3 id=\"loadablecomponent\" style=\"position:relative;\"><a href=\"#loadablecomponent\" aria-label=\"loadablecomponent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@loadable/component</h3>\n<p>@loadable/component 是社区版的一个代码分割方案，简单好用。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACSUlEQVQ4y61Ua6+aQBDl//8oE/WDNiaa+kDAB4oo1ooP5KWg0znjXUq95qY0JTnswp49O7N7ZjUqPY/HQ1rXdWk2m9FisaCFbT/bD+D/drv9g19+tHeC4/GYgiCg5HqlGIgTiqKY0jSl0+lEpmlWE7Tnc7pz/xGGRD/3RHlWcLIsI5ujriSI1GyGa1q0HVqUhT5ROqHVyiXP25DjONUEsU959oyqiO2RcnQ5JUlCc86gkiAm+L5P/n5P3mZD6/Wa9zGVsdvtVl1wuVzSZDKher1OzWaTGo1GcVBxHH+9h+on2vv9XqSMqCzLouFwKO1oNJL++XyWcTyKj7lKR3u3EqJDWqvVSgBfAlhkOp0WEb6bW0QIO8Cw2Duktuf9OxwOtNvtRAzfx+NRvuFFjF0ul88Rqg42ezAYSFqwDVJEqt1ul/r9vowh8l6vR4ZhCA/RlgUBraz+L09ZTAS/GvwbfDrlK9fq/4QGXwFRFAnQRzWo/69QvDK/DA2TcYvkeS4Hg1VeiWoBtOAB8OBVbqLnfwUNV1GtVqNOpyMn12q1xHsQVyQ1CSeM8Xb7G6MtlwTsVhbV4Hz4D+UG4wJH9hi8GARnifZJjtmjB7aULQAf81Q5KlEN6cKk8B5IqBDTmjAsMjh6d72hhDngxQlz/R/MmTLXER96niepyzj2EC+spOu6pGwbOjmmTq5l0EIfksPfvuvQ2ePIOcLg6NF49J3NPhCzIwDUNioMotrrqaY4JE4vjX8jjkKKwouMY98ggnJEH3WNzEK+3aHzC9h1SUp7wJX7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1e221816.png\"\n        title=\"1e221816.png\"\n        src=\"/static/fec26879172a13d1ea2dc574b1d78b07/00d43/1e221816.png\"\n        srcset=\"/static/fec26879172a13d1ea2dc574b1d78b07/63868/1e221816.png 250w,\n/static/fec26879172a13d1ea2dc574b1d78b07/0b533/1e221816.png 500w,\n/static/fec26879172a13d1ea2dc574b1d78b07/00d43/1e221816.png 1000w,\n/static/fec26879172a13d1ea2dc574b1d78b07/d8817/1e221816.png 1238w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>它相比于 React.lazy，最大的区别是支持服务端渲染。以及它跟 React.lazy 不冲突，还能使用 Suspense 特性，可以看作是 React.lazy 的一个增强版本：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA4UlEQVQY05WQ2W6EMAxF+f+/4wXoQ0NBEGbYtzSTQLiNPcqM1KfW0rF8s1wnjoZhQJqmyLKMobooCsRxjCRJcBwHKK7r+hPRsiwQQjBlWSLPc0gpWVdVxYf+E1EozvPEOI6vDaUUuq7Dvu8Y/S+2bcOtaVDXNaZpYvq+53Nt27Km30SU5nnmhXVdn27+Udn0AWU0rDfSQ48HoXYYa2GNgW4krL9LDzFek49zDhEl6kSzJGOqtdL4VIK9V7vgrm9oviUeTvOauxy+NvGabQieISUyJahb6ESXeI9568D5Swd+AE3C0FTDCix8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"b3918d5f.png\"\n        title=\"b3918d5f.png\"\n        src=\"/static/19754af7221e4dc7fce03ccf755b58b7/00d43/b3918d5f.png\"\n        srcset=\"/static/19754af7221e4dc7fce03ccf755b58b7/63868/b3918d5f.png 250w,\n/static/19754af7221e4dc7fce03ccf755b58b7/0b533/b3918d5f.png 500w,\n/static/19754af7221e4dc7fce03ccf755b58b7/00d43/b3918d5f.png 1000w,\n/static/19754af7221e4dc7fce03ccf755b58b7/aa440/b3918d5f.png 1500w,\n/static/19754af7221e4dc7fce03ccf755b58b7/7be33/b3918d5f.png 1558w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>使用上非常简单：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Suspense <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> lazy <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@loadable/component'</span>\n\n<span class=\"token keyword\">const</span> OtherComponent <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./OtherComponent'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OtherComponent</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"react-loadable\" style=\"position:relative;\"><a href=\"#react-loadable\" aria-label=\"react loadable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>react-loadable</h3>\n<p>react-loadable 是另一个代码分割的方案，只不是这个库相比于 比较老，官网的介绍是这样的：</p>\n<blockquote>\n<p>A higher order component for loading components with dynamic imports.</p>\n</blockquote>\n<p>可以简单看一下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> Loadable <span class=\"token keyword\">from</span> <span class=\"token string\">'react-loadable'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Loading <span class=\"token keyword\">from</span> <span class=\"token string\">'./my-loading-component'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> LoadableComponent <span class=\"token operator\">=</span> <span class=\"token function\">Loadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">loader</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./my-component'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  loading<span class=\"token operator\">:</span> Loading<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LoadableComponent</span></span><span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>react-loadable 属于上一代的方案，它很早就不维护了，不兼容 Webpack v4+ and Babel v7+。所以在目前的实践中还是考虑上面三种方案。</p>\n<h2 id=\"原理\" style=\"position:relative;\"><a href=\"#%E5%8E%9F%E7%90%86\" aria-label=\"原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>原理</h2>\n<h3 id=\"loadablecomponent-1\" style=\"position:relative;\"><a href=\"#loadablecomponent-1\" aria-label=\"loadablecomponent 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@loadable/component</h3>\n<p>这里研究一下 @loadable/component 这个库的源码。@loadable/component 其实是 @loadable 下的一个包，还有 @loadable/server、 @loadable/babel-plugin、@loadable/webpack-plugin 等包，是为服务端渲染而准备的，纯前端应该用不太到。目前只研究 @loadable/component。</p>\n<p>下载 <a href=\"https://github.com/gregberge/loadable-components\">@loadable/components</a> 源码，可以看到它的目录结构：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.19999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/klEQVQ4y5VT2Y7bMBDz//9fUXSTrE9Z1n1YMvrGMkrSTdptiz4Q8jgxRQ5nummYMfYTgg1wJsBbA60VYghI0SOlgL3uKGXHvu+o5UCtB+vS6l/RXd5H9O8D1KahlUFOGYbk42wgxYbptGI+E5OB4H/69Q3CzAjJk7j+hm5cVgzj0BTkPfOWG+EiI4yJWAcL2WtemKC9x6jOsME0hZ+h08ZgnidajNjzTfb12RkPzffBbMh871RA9BnH8R1HPZqaK8Hj/Em4iQveTl8wiRFSC7jg2EcLPY4w6wanHezmG9y8IHv/SlJf0Tm14Hz6BqU1YoqIMdCqgZEaVm0MJvFkYDoiMahra9rHn5A1wmhWhnKGUrrZTTmTQMGuCl5ZuI0XrCQUCmUvLeFa6hOOF3ReSUxjzyAse5U5JlTkFDa3QFiBzdJ6mOCKhK8bcTtDe37UH+iscbR8gpSyNT/RtpAK4+qxjDPVLQhKMDBPBxG58tLC1hSPzLMc+xMyQ+HHl8sFlgqbZRKu7J/YaH0STFpzbCTWrxdsg4RcAgRHrR8GCEFVJhGRoQUuR0I3UMU8zwwjNssP3FKsrW97vm5FJUobreu7sj9+2z/AuuuHBcuy3NWl23q1qS931Ke6/qW+b4rkbE0c4IeyB+GfNuFf6KZhhFo5g4690KHt8vMW/C9+AP/qJeTaW+lGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"e41f7eac.png\"\n        title=\"e41f7eac.png\"\n        src=\"/static/e878f0359edc204dcdb74152ada0dba5/00d43/e41f7eac.png\"\n        srcset=\"/static/e878f0359edc204dcdb74152ada0dba5/63868/e41f7eac.png 250w,\n/static/e878f0359edc204dcdb74152ada0dba5/0b533/e41f7eac.png 500w,\n/static/e878f0359edc204dcdb74152ada0dba5/00d43/e41f7eac.png 1000w,\n/static/e878f0359edc204dcdb74152ada0dba5/aa440/e41f7eac.png 1500w,\n/static/e878f0359edc204dcdb74152ada0dba5/e8950/e41f7eac.png 2000w,\n/static/e878f0359edc204dcdb74152ada0dba5/79538/e41f7eac.png 2530w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>最重要的部分是在 createLoadable.js 中：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createLoadable</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span>\n  defaultResolveComponent <span class=\"token operator\">=</span> identity<span class=\"token punctuation\">,</span>\n  render<span class=\"token punctuation\">,</span>\n  onLoad<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">loadable</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">loadableConstructor<span class=\"token punctuation\">,</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> ctor <span class=\"token operator\">=</span> <span class=\"token function\">resolveConstructor</span><span class=\"token punctuation\">(</span>loadableConstructor<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 获取缓存的 key，key 发生改变的时候会 reload 新资源</span>\n      <span class=\"token keyword\">function</span> <span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 将加载进来的模块通过 options.resolveComponent 取出模块</span>\n      <span class=\"token keyword\">function</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">module<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> Loadable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 内部主类</span>\n      <span class=\"token keyword\">class</span> <span class=\"token class-name\">InnerLoadable</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">static</span> <span class=\"token function\">getDerivedStateFromProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span> state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> cacheKey <span class=\"token operator\">=</span> <span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n            cacheKey<span class=\"token punctuation\">,</span>\n            <span class=\"token comment\">// key 的改变会触发新的 render 流程</span>\n            loading<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>loading <span class=\"token operator\">||</span> state<span class=\"token punctuation\">.</span>cacheKey <span class=\"token operator\">!==</span> cacheKey<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n\n          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            result<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            error<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            loading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            cacheKey<span class=\"token operator\">:</span> <span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n          <span class=\"token comment\">// 获取缓存</span>\n          <span class=\"token keyword\">const</span> cachedPromise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token comment\">// 如果 promise 状态是失败的，则清理</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cachedPromise <span class=\"token operator\">&amp;&amp;</span> cachedPromise<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token constant\">STATUS_REJECTED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token comment\">// 当还在 loading 的时候，则 loadAsync</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>loading<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prevProps<span class=\"token punctuation\">,</span> prevState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 只在 key 变更后才触发变化</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevState<span class=\"token punctuation\">.</span>cacheKey <span class=\"token operator\">!==</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>cacheKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">componentWillUnmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">safeSetState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">nextState<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">setCache</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          cache<span class=\"token punctuation\">[</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">triggerOnLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>onLoad<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token function\">onLoad</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 同步加载模块，在一些场景有用，比如 node 端（webpack target=node）</span>\n        <span class=\"token function\">loadSync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 核心：异步加载模块，加载和解析过程分解的</span>\n        <span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolveAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n          promise\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">loadedModule</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>loadedModule<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Loadable <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">safeSetState</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">{</span>\n                  result<span class=\"token punctuation\">,</span>\n                  loading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">triggerOnLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">safeSetState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">,</span> loading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n          <span class=\"token keyword\">return</span> promise\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 核心：异步解析模块</span>\n        <span class=\"token function\">resolveAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> __chunkExtractor<span class=\"token punctuation\">,</span> forwardedRef<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props\n\n          <span class=\"token keyword\">let</span> promise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>promise<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// requireAsync 就是使用中用到的 () => import('./')，它会返回一个 promise</span>\n            promise <span class=\"token operator\">=</span> ctor<span class=\"token punctuation\">.</span><span class=\"token function\">requireAsync</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n            promise<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token constant\">STATUS_PENDING</span>\n\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setCache</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">)</span>\n\n            promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n              <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                promise<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token constant\">STATUS_RESOLVED</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                promise<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token constant\">STATUS_REJECTED</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n\n          <span class=\"token keyword\">return</span> promise\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// render 函数，其实就是 React 组件的 render，没有啥特别的</span>\n        <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n            forwardedRef<span class=\"token punctuation\">,</span>\n            fallback<span class=\"token operator\">:</span> propFallback<span class=\"token punctuation\">,</span>\n            __chunkExtractor<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>props\n          <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props\n          <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> error<span class=\"token punctuation\">,</span> loading<span class=\"token punctuation\">,</span> result <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state\n          <span class=\"token comment\">// suspense 功能配置</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>suspense<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> cachedPromise <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cachedPromise<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token constant\">STATUS_PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">throw</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token comment\">// 错误则 throw</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> error\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token comment\">// 兜底 loading</span>\n          <span class=\"token keyword\">const</span> fallback <span class=\"token operator\">=</span> propFallback <span class=\"token operator\">||</span> options<span class=\"token punctuation\">.</span>fallback <span class=\"token operator\">||</span> <span class=\"token keyword\">null</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loading<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> fallback\n          <span class=\"token punctuation\">}</span>\n          \n          <span class=\"token keyword\">return</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            fallback<span class=\"token punctuation\">,</span>\n            result<span class=\"token punctuation\">,</span>\n            options<span class=\"token punctuation\">,</span>\n            props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>props<span class=\"token punctuation\">,</span> ref<span class=\"token operator\">:</span> forwardedRef <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 这里是对于 InnerLoadable 做一些增强功能，包括转发 ref</span>\n      <span class=\"token keyword\">const</span> EnhancedInnerLoadable <span class=\"token operator\">=</span> <span class=\"token function\">withChunkExtractor</span><span class=\"token punctuation\">(</span>InnerLoadable<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> Loadable <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">forwardRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span> ref</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>EnhancedInnerLoadable forwardedRef<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>ref<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// preload 功能</span>\n      Loadable<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">preload</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">props</span> <span class=\"token operator\">=></span> ctor<span class=\"token punctuation\">.</span><span class=\"token function\">requireAsync</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">return</span> Loadable\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctor<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> loadable<span class=\"token punctuation\">,</span> lazy <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> createLoadable</code></pre></div>\n<p>整体阅读下来不难，就是一个 React 组件，内部去调用 loadAsync()，帮开发者去管理懒加载资源，本质上还是跑 import() 命令，在 Webpack 的编译下，也是 Promise + document.createElement('script') 这一套。</p>\n<p>lazy 部分的函数我没有研究，因为这个需要深入看一下 React.lazy 和 Suspense 的东西，所以先放一放，后续有需要再说。</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://github.com/gregberge/loadable-components\">GitHub - gregberge/loadable-components: The recommended Code Splitting library for React ✂️✨</a></li>\n<li><a href=\"https://github.com/jamiebuilds/react-loadable\">GitHub - jamiebuilds/react-loadable: A higher order component for loading components with promises.</a></li>\n<li><a href=\"https://zh-hans.reactjs.org/docs/code-splitting.html\">代码分割 – React</a></li>\n</ul>","fields":{"slug":"/content/React-React 体系的懒加载方案及其原理/"},"frontmatter":{"title":"React 体系的懒加载方案及其原理","category":"React","tags":"React_Usage","date":"2020-11-04"}}},"pageContext":{"slug":"/content/React-React 体系的懒加载方案及其原理/"}},"staticQueryHashes":["3649515864"]}