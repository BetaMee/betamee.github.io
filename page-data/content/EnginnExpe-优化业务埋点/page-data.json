{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/content/EnginnExpe-优化业务埋点/","result":{"data":{"site":{"siteMetadata":{"author":"橡树上","title":"十二棵橡树"}},"markdownRemark":{"id":"00d0f954-9b47-59eb-92fe-4b06284894c9","html":"<h2 id=\"目录\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%BD%95\" aria-label=\"目录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目录</h2>\n<!-- toc -->\n<ul>\n<li><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></li>\n<li><a href=\"#%E8%AE%BE%E8%AE%A1-API\">设计 API</a></li>\n<li><a href=\"#%E9%99%90%E5%88%B6\">限制</a></li>\n<li><a href=\"#%E6%95%88%E6%9E%9C\">效果</a></li>\n<li><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>\n<!-- tocstop -->\n<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>在学习 requestIdleCallback 这个 API 的时候，想到一个很棒的代码优化的解决方案。</p>\n<p>背景是这样的，在我们自身的业务项目中，经常需要做些埋点工作：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">handleBook</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 校验逻辑</span>\n     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkpay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     <span class=\"token comment\">// 埋点</span>\n     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">checkpay</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 很多业务逻辑</span>\n     <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">log</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 很多计算逻辑</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里就会有一些问题，对于应用来说，handleBook() 中的 checkpay() 是实际的主流程业务功能，而 log() 是额外的“附加功能”。随着业务的增长，我们可能会在 log() 中埋入一些自定义的用户行为数据，或者根据产品的需求，埋入用户带入的产品数据，这些七七八八的数据也是需要从整个应用 state 中取值、Mapping、乃至复杂计算，对于用户来说，这种额外的计算负担并为其所需，有时甚至会影响到页面交互的流畅。</p>\n<p>我们知道，JavaScript 是单线程模型，如果一个函数计算量很大，它会阻塞主线程，造成运行的卡顿。而 requestIdleCallback 的本质是交给浏览器合理安排 JS 任务，也就说是可以将一些低优先级的函数放置在浏览器的 idle 期间执行，以达到平衡主线程的压力。</p>\n<p>而另一方面，log() 埋点本身也没有啥特别的依赖，逻辑上十分简单，只需要数据 + 接口调用。</p>\n<p>所以，我们大可以将这些 log() 埋点功能放在 requestIdleCallback 中，只在浏览器空闲的 idle 期间去执行这些任务，既不会影响主流程业务，又能妥善利用浏览器的空闲性能。</p>\n<h2 id=\"设计-api\" style=\"position:relative;\"><a href=\"#%E8%AE%BE%E8%AE%A1-api\" aria-label=\"设计 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>设计 API</h2>\n<p>单独的使用 requestIdleCallback 其实是不难的，难的是如何嵌入已有的业务流程中，提供最小化更新。React 项目中，一般都是定一个组件，然后加上各自的功能，所以我们可以使用 Decorator 装饰器模式来增强函数：</p>\n<p>定义：</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isFunction</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'[object Function]'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">IdleProps</span> <span class=\"token punctuation\">{</span>\n    timeout<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> IdleTasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">runIdleTask</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> opts<span class=\"token operator\">:</span> IdleProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">myNonEssentialWork</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// deadline.timeRemaining() 可以获取到当前帧剩余时间</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> deadline<span class=\"token punctuation\">.</span>didTimeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> IdleTasks<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            t <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IdleTasks<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            window<span class=\"token punctuation\">.</span><span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>myNonEssentialWork<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> timeout<span class=\"token operator\">:</span> opts<span class=\"token punctuation\">.</span>timeout <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>requestIdleCallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 新增 task</span>\n        IdleTasks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 执行 idle 工作</span>\n        window<span class=\"token punctuation\">.</span><span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>myNonEssentialWork<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> timeout<span class=\"token operator\">:</span> opts<span class=\"token punctuation\">.</span>timeout <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 兼容不存在的 API</span>\n        task <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">defineIdleTask</span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 适配函数组件中的普通函数</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">runIdleTask</span><span class=\"token punctuation\">(</span><span class=\"token function\">task</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> timeout<span class=\"token operator\">:</span> <span class=\"token number\">500</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 适配 class 类组件</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n            target<span class=\"token punctuation\">,</span>\n            propertyKey<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n            descriptor<span class=\"token operator\">:</span> PropertyDescriptor\n        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">[</span>propertyKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>propertyKey<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: Plz do not use arrow function for class decorator binding, use normal function instead.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">const</span> originTask <span class=\"token operator\">=</span> descriptor<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n            descriptor<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">value</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// 这里的 this 是跟随原来类的，所以不能使用箭头函数，会造成 this 丢失</span>\n                    <span class=\"token function\">runIdleTask</span><span class=\"token punctuation\">(</span><span class=\"token function\">originTask</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> timeout<span class=\"token operator\">:</span> <span class=\"token number\">500</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> defineIdleTask<span class=\"token punctuation\">;</span></code></pre></div>\n<p>使用：</p>\n<p>类组件</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> defineIdleTask <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/idleTask'</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Book</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 手动绑定</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>log <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">handleBook</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 校验逻辑</span>\n     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">checkpay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     <span class=\"token comment\">// 埋点</span>\n     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function-variable function\">checkpay</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 很多业务逻辑</span>\n     <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 只需一小行代码，就能使用了！</span>\n  @<span class=\"token function\">defineIdleTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 很多计算逻辑</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>div onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleBook<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>Book<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>函数组件</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> defineIdleTask <span class=\"token keyword\">from</span> <span class=\"token string\">'shared/idleTask'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Book</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">checkpay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 很多业务逻辑</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 很多计算逻辑</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 被 idle 的函数</span>\n  <span class=\"token keyword\">const</span> idleLog <span class=\"token operator\">=</span> <span class=\"token function\">defineIdleTask</span><span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">function</span> <span class=\"token function\">handleBook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 校验逻辑</span>\n      <span class=\"token function\">checkpay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 埋点</span>\n      <span class=\"token function\">idleLog</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>a<span class=\"token operator\">:</span><span class=\"token string\">'dfa'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>handleBook<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>BookHook<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Book<span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"限制\" style=\"position:relative;\"><a href=\"#%E9%99%90%E5%88%B6\" aria-label=\"限制 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>限制</h2>\n<p>需要注意的一点，在 React 的类组件中，使用 Decorator 增强必须满足的一点是，函数不能是箭头函数，因为在 es6 的 class 类中，箭头函数是作为变量属性被绑在类实例上的，而非类的原型上，这就造成了 Decorator 读不到当前实例，也就无法获取 this，这对于被增强函数中要使用 this 带来了麻烦，所以为了避免这个问题，直接使用普通函数手动绑定吧。</p>\n<p>具体原因可以搜索 Decorator + Arrow Function 关键词了解背后详情，这说明了 Decorator 标准还不够成熟。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 692px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.2%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQklEQVQ4y52S6U7DMBCE8/6vhyg/EFdJm8N34jPXsE6hKkJAU0uJLGv9eWZ3ihQSTKmhnxkYs2iZRIoePgTM84xlWTZ9BRagYx34yxGCa7Qtg9ccQsq1YOsq8s/0HcrjEUopSAJhnhBj3KxuVZhtOefJ3nKToh8KU0qo6gr7/Z7stijLEtMNvTsrjCHClgaiFmg5XwcBLLcDx3GEbAQ44+BCoDMaxs0YppOFrV0oiAtNkPrQrJbrpkLDFBiXyI+doFtiQytQ5qxx8CbAUIScsdBan4HzxYWvB/6MzTRN6Ali2g5Kerw+vdPk3WfJ98uX0F8V5pUBWZ3hDqKR6LlF7CNimvB2CDjUlnIqr1OYC6yzCD1ZrjpY5giWoITCbveAu/tHGli3tuD/2AynTbY9xAFjGjEO47rPZ9ZaeG+pZr5qQB+qR/yPMaAXogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7af72063.png\"\n        title=\"7af72063.png\"\n        src=\"/static/9ebbc47c6b837639929e96beacd5f6c2/91e7e/7af72063.png\"\n        srcset=\"/static/9ebbc47c6b837639929e96beacd5f6c2/63868/7af72063.png 250w,\n/static/9ebbc47c6b837639929e96beacd5f6c2/0b533/7af72063.png 500w,\n/static/9ebbc47c6b837639929e96beacd5f6c2/91e7e/7af72063.png 692w\"\n        sizes=\"(max-width: 692px) 100vw, 692px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"效果\" style=\"position:relative;\"><a href=\"#%E6%95%88%E6%9E%9C\" aria-label=\"效果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>效果</h2>\n<p>通过以上方案的改造，我们可以对比一下优化前后的差异：</p>\n<p>优化前：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.599999999999994%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVQoz5WSDW+aUBiF+f//Zlm2JYtdZteuVq2Kiiio9WPKh6CgRUCFZy/qTJZlS0by5HDPS869nFzldMopnvSU8RbHxMcjaZaJHnB2rvin8zz/B9mVPM9RXHuCbxmsbfOGb4kKgTM6azG/cH0vvlkOWM97go4364r2CVYrFGOo8lB7T3f0SGf48Bvt4bc/vF90i7l5jzF6wp83CR2d9WaHMllt+dRqU/mxpLHy/gOfuuvR32yJpZWCMEpRXt2Ajx2d8mRBxV5f8a/8bX3hu3gdLySKj+zTjHCXSKDj86H6zNN4TNNxeLHtGw3LumBbvDiFZ90ovLq1QPd8ojSXwPwSGAQ7dKNGqfKOevszLe2OrvYFtVuiapSpSY+N3h1NtURTK9Pq3V8RX/uKOVbZR4dzaCT/rbzF4OwTqgtTdpthrpdUDA11OGC+9ZluPZwwYGwatNtV+oMOel8V2mh6i9FgzH6bEB1yYglVNrLYSwdJcewkJz3C1AuwpGy5isRxRiIa7EKGiwpTt85EKPTVfWYym/EWFXf4eO7yJ9eflDenszP/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"7416ffb1.png\"\n        title=\"7416ffb1.png\"\n        src=\"/static/08c1dab2eb28452afb98059529d0d078/00d43/6082be5a.png\"\n        srcset=\"/static/08c1dab2eb28452afb98059529d0d078/63868/6082be5a.png 250w,\n/static/08c1dab2eb28452afb98059529d0d078/0b533/6082be5a.png 500w,\n/static/08c1dab2eb28452afb98059529d0d078/00d43/6082be5a.png 1000w,\n/static/08c1dab2eb28452afb98059529d0d078/aa440/6082be5a.png 1500w,\n/static/08c1dab2eb28452afb98059529d0d078/29114/6082be5a.png 1920w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>优化后：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvklEQVQoz1WSa2/aMBRA+f8/Z5q0TVq1dtMGKt1K17VAQshCeAYIkNiO8yBnl7R07Ycj+9q5x/faaRljsNZi87LBGItSOamyLFYRN4MbnNAl2m7Qsm5MgTYlWpfNmKQ569g0xHtNSylNUZSUFRTCLs6IlpbNpmKxUDheiOfPCacxm+i0XhLHsN2eqCWuiaKqYS37ra1Yk1TjPV4x87tM/DGB+4Db+8rM8+QjJYlZsx7+DfD/dOm33+P//EBw+5Gg94mJzCfX71g4j7TSrMbkNd9+dxiEI5kX7NMd82BEsomxhewLKrPSZsZhNePu7jND7wJ3fCl8aUZH4mjp00pMRSYJV32X++kKW0rbcjdylSIHbY8NKjs+z2EYODjRD7xtV7h+IUpWT0JbwOXQpzeNGuFeFyhbofPjK2H1hDkyX63xl/eMFh2hi7/+hbvssD4s/wvbt9/pe315IFAi1JJs7FuhfpZqOSyVUveHROKiiQdhm3WyEKG0kkuC4zwwGPdJ4j3xasNOULtUqqzfCJsDTofldXMl53G2DTjo5FThkUxa2yWGmTyCTjOSgyYV9OmfeyVUZ6GtXio/k4lUiuUfda2nM99Yvy8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9acfdc17.png\"\n        title=\"9acfdc17.png\"\n        src=\"/static/572c0777a75def3e678946ad3972ab97/00d43/9acfdc17.png\"\n        srcset=\"/static/572c0777a75def3e678946ad3972ab97/63868/9acfdc17.png 250w,\n/static/572c0777a75def3e678946ad3972ab97/0b533/9acfdc17.png 500w,\n/static/572c0777a75def3e678946ad3972ab97/00d43/9acfdc17.png 1000w,\n/static/572c0777a75def3e678946ad3972ab97/aa440/9acfdc17.png 1500w,\n/static/572c0777a75def3e678946ad3972ab97/29114/9acfdc17.png 1920w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>可以看到，使用 requestIdleCallback 后，可以合理地将两个 log 函数分配到浏览器空余时间，而主流程代码 handleSearchFlights 耗时从 50+ms 直接跌到了 12+ms，优化幅度巨大。</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://betamee.github.io/content/WebFrontEnd-%E7%90%86%E8%A7%A3%20requestIdleCallback/\">理解 requestIdleCallback</a></li>\n</ul>","fields":{"slug":"/content/EnginnExpe-优化业务埋点/"},"frontmatter":{"title":"优化业务埋点","category":"EnginnExpe","tags":"practice","date":"2020-12-24"}}},"pageContext":{"slug":"/content/EnginnExpe-优化业务埋点/"}},"staticQueryHashes":["3649515864"]}